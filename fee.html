<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fee Collection (PWA) ‚Äì Complete Working Version</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
font-family: Arial, sans-serif;
margin:0 auto;
max-width:900px;
padding:20px;
background:linear-gradient(135deg,#f1f8e9,#e3f2fd);
}
h1{
text-align:center;
color:#1b5e20;
font-size:24px;
margin-bottom:8px;
}
.bill-header{
text-align:center;
background:#ffffff;
padding:15px;
border-radius:8px;
border:2px solid #c8e6c9;
margin-bottom:15px;
position:relative;
}
.bill-header img{
position:absolute;
right:20px;
top:20px;
width:60px;
height:60px;
}
.status-bar{
padding:8px;
background:#e8f5e9;
border-radius:6px;
margin-bottom:15px;
color:#2e7d32;
font-size:12px;
}
.card{
background:#fff;
border-radius:8px;
padding:20px;
box-shadow:0 2px 8px rgba(0,0,0,0.2);
margin-bottom:20px;
}
form{
display:grid;
grid-template-columns:1fr 2fr;
gap:10px 15px;
}
label{
font-weight:bold;
color:#1b5e20;
}
input,select,textarea{
width:100%;
padding:7px;
border-radius:4px;
border:1px solid #a5d6a7;
box-sizing:border-box;
}
textarea{ resize:vertical; }
.full-row{ grid-column:1/3; }
.fee-section{
margin-top:10px;
padding:10px;
background:#f9fbe7;
border-radius:6px;
border-left:4px solid #cddc39;
}
.inline-row{
display:flex;
gap:6px;
align-items:center;
}
.inline-row input[type="number"]{
max-width:120px;
}
.admission-row{
display:flex;
flex-wrap:wrap;
gap:6px;
align-items:center;
margin-top:6px;
}
.admission-row label.small{
font-size:12px;
font-weight:normal;
color:#33691e;
}
.tag-row{
display:flex;
flex-wrap:wrap;
gap:6px;
margin-top:4px;
}
.tag{
display:inline-flex;
align-items:center;
gap:3px;
padding:3px 8px;
border-radius:999px;
border:1px solid #a5d6a7;
background:#e8f5e9;
font-size:12px;
white-space:nowrap;
}
.tag input{
width:auto;
margin:0;
}
.toolbar{
margin-top:20px;
display:flex;
flex-wrap:wrap;
gap:10px;
}
.btn{
padding:8px 14px;
border:none;
color:#fff;
cursor:pointer;
border-radius:4px;
font-weight:600;
box-shadow:0 2px 4px rgba(0,0,0,0.2);
font-size:13px;
}
.btn-save{background:#2e7d32;}
.btn-edit{background:#0277bd;}
.btn-delete{background:#c62828;}
.btn-print{background:#ef6c00;}
.btn-prev{background:#5d4037;}
.btn-next{background:#00897b;}
.btn-home{background:#6a1b9a;}
.btn-search{background:#1e88e5;}
.btn-student{background:#00838f;}
.btn-report{background:#d81b60;}
.btn-csv{background:#1976d2;}
.btn-manual{background:#7b1fa2;}
.search-box{
display:flex;
gap:5px;
align-items:center;
margin-top:10px;
}
.search-box input{ width:140px; }
.section-title{
margin-top:0;
margin-bottom:8px;
color:#1b5e20;
}
.filter-bar{
display:flex;
flex-wrap:wrap;
gap:10px;
margin-bottom:10px;
align-items:flex-end;
}
.filter-field{
display:flex;
flex-direction:column;
gap:3px;
}
.filter-field label{
font-size:12px;
color:#33691e;
font-weight:600;
}
.table-wrapper{
max-height:260px;
overflow:auto;
border:1px solid #c8e6c9;
border-radius:6px;
}
table.fee-table{
border-collapse:collapse;
width:100%;
font-size:12px;
}
table.fee-table th,
table.fee-table td{
padding:6px 5px;
border:1px solid #a5d6a7;
text-align:left;
white-space:nowrap;
}
table.fee-table th{
background:#a5d6a7;
color:#1b5e20;
position:sticky;
top:0;
z-index:1;
}
table.fee-table tr:nth-child(even){ background:#f1f8e9; }
table.fee-table tr:hover{ background:#dcedc8; }
.small-btn{
padding:3px 6px;
border:none;
border-radius:3px;
font-size:11px;
color:#fff;
cursor:pointer;
}
.sb-print{background:#ef6c00;}
.sb-edit{background:#0277bd;}
.sb-del{background:#c62828;}
.sb-view{background:#5d4037;}
@media(max-width:600px){
form{ grid-template-columns:1fr; }
.full-row{ grid-column:1/2; }
.toolbar{ flex-direction:column; }
.filter-bar{flex-direction:column;align-items:flex-start;}
}
</style>
</head>
<body>
<h1>FEE COLLECTION</h1>
<div class="bill-header">
<strong style="font-size:18px;">CHATUSHPATHI FOUNDATION</strong><br>
True education uplifts the self<br>
Regd. Office : Chhatimtala, P.O.- Chakdaha, Dist.- Nadia, PIN-741222<br>
Contact- 9064880703 | Email : <a href="mailto:chatushpathifoundation@gmail.com">chatushpathifoundation@gmail.com</a>
<img src="logo.png" alt="School Logo">
</div>
<div class="status-bar">
Status: <span id="statusText">Loading...</span> | 
Storage: <span id="storageType">LocalStorage</span> |
Records: <span id="recordCount">0</span>
</div>
<div class="card">
<form id="feeForm">
<!-- BILL NUMBER -->
<label>BILL NUMBER:</label>
<input type="text" id="billNo" readonly style="background:#e8f5e9;font-weight:bold;color:#1b5e20;">
<!-- STUDENT INFO SECTION -->
<div class="full-row" style="background:#e3f2fd;padding:10px;border-radius:5px;margin-bottom:10px;">
<strong style="color:#1565c0;">STUDENT INFORMATION</strong>
</div>
<!-- STUDENT NAME -->
<label>STUDENT NAME:</label>
<div class="inline-row">
<input type="text" id="studentName" style="flex:1;">
<button type="button" id="manualStudentBtn" class="btn btn-manual" style="padding:5px 10px;font-size:12px;">Manual Entry</button>
</div>
<!-- UNIQUE ID -->
<label>UNIQUE ID (Student ID):</label>
<input type="text" id="studentId" placeholder="ST0001" style="background:#fff3e0;">
<!-- CLASS -->
<label>CLASS:</label>
<input type="text" id="className" placeholder="e.g., CLASS - I">
<!-- SECTION -->
<label>SECTION:</label>
<input type="text" id="section" placeholder="e.g., A">
<!-- ROLL -->
<label>ROLL:</label>
<input type="text" id="roll" placeholder="e.g., 1">
<!-- PAYMENT INFO SECTION -->
<div class="full-row" style="background:#f3e5f5;padding:10px;border-radius:5px;margin:10px 0;">
<strong style="color:#7b1fa2;">PAYMENT INFORMATION</strong>
</div>
<!-- PAYMENT DATE -->
<label>DATE OF PAYMENT:</label>
<input type="date" id="payDate">
<label>Formatted Date:</label>
<span id="payDateFancy" class="full-row" style="font-size:13px;color:#33691e;font-weight:bold;"></span>
<!-- NEW FEE MONTH -->
<label>MONTH:</label>
<select id="feeMonth">
<option value="">Select Month</option>
<option value="01">January</option>
<option value="02">February</option>
<option value="03">March</option>
<option value="04">April</option>
<option value="05">May</option>
<option value="06">June</option>
<option value="07">July</option>
<option value="08">August</option>
<option value="09">September</option>
<option value="10">October</option>
<option value="11">November</option>
<option value="12">December</option>
</select>
<!-- NEW FEE YEAR -->
<label>YEAR:</label>
<input type="number" id="feeYear" placeholder="2025" value="2025">
<!-- ADMISSION FEES -->
<div class="fee-section full-row">
<label class="full-row">ADMISSION FEES:</label>
<div class="admission-row">
<select id="admissionType">
<option value="">Select Type</option>
<option value="FULL PAYMENT">FULL PAYMENT</option>
<option value="INSTALLMENT">INSTALLMENT</option>
</select>
<input type="number" id="admissionAmount" placeholder="Amount" value="0" disabled>
<label class="small">INSTALLMENT MONTH/YEAR:</label>
<input type="month" id="installMonth" disabled>
</div>
</div>
<!-- DEVELOPMENT FEES -->
<label>DEVELOPMENT FEES:</label>
<div class="inline-row">
<select id="developmentType">
<option value="">Select Type</option>
<option value="EARLY SESSION">EARLY SESSION</option>
<option value="REGULAR SESSION">REGULAR SESSION</option>
</select>
<input type="number" id="developmentAmount" placeholder="Amount" value="0">
</div>
<!-- UNIFORM -->
<label>SCHOOL UNIFORM:</label>
<div class="inline-row">
<select id="uniformType">
<option value="">Select Type</option>
<option value="WINTER">WINTER</option>
<option value="REGULAR">REGULAR</option>
</select>
<input type="number" id="uniformSets" placeholder="No. of sets" value="0">
</div>
<!-- SCHOOL KIT -->
<div class="fee-section full-row" id="kitSection">
<label class="full-row">SCHOOL KIT:</label>
<div style="font-size:12px;font-weight:bold;color:#33691e;margin-top:4px;">DELIVERED:</div>
<div class="tag-row">
<label class="tag"><input type="checkbox" class="kit-given" value="BOOKS">BOOKS</label>
<label class="tag"><input type="checkbox" class="kit-given" value="SHOE">SHOE</label>
<label class="tag"><input type="checkbox" class="kit-given" value="BAG">BAG</label>
<label class="tag"><input type="checkbox" class="kit-given" value="STATIONERY">STATIONERY</label>
<label class="tag"><input type="checkbox" class="kit-given" value="DRESS">1 SET DRESS</label>
</div>
<div style="font-size:12px;font-weight:bold;color:#33691e;margin-top:6px;">DUE ITEMS:</div>
<div class="tag-row">
<label class="tag"><input type="checkbox" class="kit-due" value="BOOKS">BOOKS</label>
<label class="tag"><input type="checkbox" class="kit-due" value="SHOE">SHOE</label>
<label class="tag"><input type="checkbox" class="kit-due" value="BAG">BAG</label>
<label class="tag"><input type="checkbox" class="kit-due" value="STATIONERY">STATIONERY</label>
<label class="tag"><input type="checkbox" class="kit-due" value="DRESS">1 SET DRESS</label>
</div>
</div>
<!-- OTHER FEES -->
<label>TIFFIN / FOOD CHARGE:</label>
<input type="number" id="tiffin" value="0">
<label>MISC. FEE:</label>
<input type="number" id="misc" value="0">
<label>PICNIC:</label>
<input type="number" id="picnic" value="0">
<label>FIELD TRIP:</label>
<input type="number" id="fieldtrip" value="0">
<label>SPORTS:</label>
<input type="number" id="sports" value="0">
<!-- MODE OF PAYMENT -->
<label>PAYMENT MODE:</label>
<select id="paymentMode">
<option value="CASH">CASH</option>
<option value="ONLINE">ONLINE</option>
<option value="UPI">UPI</option>
</select>
<!-- TOTAL AMOUNT -->
<label>TOTAL AMOUNT:</label>
<input type="number" id="totalAmount" readonly style="background:#e8f5e9;font-weight:bold;font-size:16px;color:#c62828;">
<label>Total (in words):</label>
<span id="totalInWords" class="full-row" style="font-size:13px;color:#33691e;font-style:italic;font-weight:bold;"></span>
</form>
<div class="toolbar">
<button class="btn btn-save" id="saveBtn">üíæ SAVE</button>
<button class="btn btn-edit" id="editBtn">‚úèÔ∏è EDIT</button>
<button class="btn btn-delete" id="deleteBtn">üóëÔ∏è DELETE</button>
<button class="btn btn-print" id="printBtn">üñ®Ô∏è PRINT</button>
<button class="btn btn-home" id="homeBtn">üè† HOME</button>
<button class="btn btn-student" id="studentBtn">üë®‚Äçüéì STUDENT PAGE</button>
<button class="btn btn-prev" id="prevBtn">‚¨ÖÔ∏è PREV</button>
<button class="btn btn-next" id="nextBtn">‚û°Ô∏è NEXT</button>
<div class="search-box">
<input type="text" id="searchBill" placeholder="Bill No (BL0001)">
<button class="btn btn-search" id="searchBtn">üîç SEARCH</button>
</div>
<button class="btn btn-csv" id="csvExportBtn">üìä CSV EXPORT</button>
<button class="btn btn-report" id="studentReportBtn">üìã STUDENT REPORT</button>
<button class="btn" id="backupBtn" style="background:#ff9800;">üì§ BACKUP DATA</button>
<button class="btn" id="addSampleBtn" style="background:#43a047;">‚ûï ADD SAMPLE DATA</button>
</div>
</div> <!-- /card main -->
<!-- SAVED FEE RECORDS -->
<div class="card">
<h3 class="section-title">Student Payment History (Current ID)</h3>
<div class="table-wrapper" style="max-height:160px;margin-bottom:15px;">
<table class="fee-table">
<thead>
<tr>
<th>Bill</th>
<th>Date</th>
<th>Total</th>
<th>Mode</th>
<th>View</th>
</tr>
</thead>
<tbody id="studentHistoryBody">
</tbody>
</table>
</div>
<h3 class="section-title">All Fee Records</h3>
<div class="filter-bar">
<div class="filter-field">
<label for="filterName">Name</label>
<input type="text" id="filterName" placeholder="Student name">
</div>
<div class="filter-field">
<label for="filterId">Student ID</label>
<input type="text" id="filterId" placeholder="ST0001">
</div>
<div class="filter-field">
<label for="filterClass">Class</label>
<input type="text" id="filterClass" placeholder="CLASS ‚Äì I">
</div>
<div class="filter-field">
<label for="filterMonth">Month</label>
<select id="filterMonth">
<option value="">All</option>
<option value="01">January</option>
<option value="02">February</option>
<option value="03">March</option>
<option value="04">April</option>
<option value="05">May</option>
<option value="06">June</option>
<option value="07">July</option>
<option value="08">August</option>
<option value="09">September</option>
<option value="10">October</option>
<option value="11">November</option>
<option value="12">December</option>
</select>
</div>
<div class="filter-field">
<label for="filterYear">Year</label>
<input type="number" id="filterYear" placeholder="2025">
</div>
<div class="filter-field">
<button class="btn btn-search" type="button" id="filterApply">APPLY</button>
</div>
<div class="filter-field">
<button class="btn btn-delete" type="button" id="filterReset">RESET</button>
</div>
</div>
<div class="table-wrapper">
<table class="fee-table" id="feeTable">
<thead>
<tr>
<th>Bill</th>
<th>Student ID</th>
<th>Name</th>
<th>Class</th>
<th>Month</th>
<th>Year</th>
<th>Admission</th>
<th>Develop.</th>
<th>Uniform</th>
<th>Tiffin</th>
<th>Misc</th>
<th>Picnic</th>
<th>FieldTrip</th>
<th>Sports</th>
<th>Total</th>
<th>Mode</th>
<th>Print</th>
<th>Edit</th>
<th>Delete</th>
</tr>
</thead>
<tbody id="feeTableBody"></tbody>
</table>
</div>
<div style="margin-top:15px;padding:10px;background:#fff3e0;border-radius:6px;font-size:12px;">
<strong>üìä Statistics:</strong> 
Total Records: <span id="totalRecords">0</span> | 
Total Amount: ‚Çπ<span id="totalAmountSum">0</span> | 
Last Updated: <span id="lastUpdated">Never</span>
</div>
</div>

<!-- Manual Student Entry Modal -->
<div id="studentModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
<div style="background:white;padding:20px;border-radius:10px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto;">
<h3 style="color:#1b5e20;margin-top:0;">Manual Student Entry</h3>
<div style="display:grid;gap:10px;margin-bottom:15px;">
<label>Student ID:</label>
<input type="text" id="modalStudentId" placeholder="ST001">
<label>Full Name:</label>
<input type="text" id="modalStudentName" placeholder="Enter full name">
<label>Class:</label>
<input type="text" id="modalClassName" placeholder="CLASS - I">
<label>Section:</label>
<input type="text" id="modalSection" placeholder="A">
<label>Roll Number:</label>
<input type="text" id="modalRoll" placeholder="1">
<label>Parent Name:</label>
<input type="text" id="modalParentName" placeholder="Parent's name">
<label>Contact Number:</label>
<input type="text" id="modalContact" placeholder="Phone number">
</div>
<div style="display:flex;gap:10px;justify-content:flex-end;">
<button class="btn" id="modalCancelBtn" style="background:#757575;">Cancel</button>
<button class="btn btn-save" id="modalSaveBtn">Save Student</button>
</div>
</div>
</div>

<script>
// ==================== CONFIGURATION ====================
const APP_NAME = "chatushpathi_fee_system";
const FEE_STORAGE_KEY = APP_NAME + "_fees";
const STUDENT_STORAGE_KEY = APP_NAME + "_students";
const LAST_BILL_KEY = APP_NAME + "_last_bill";

// ==================== HELPER FUNCTIONS ====================
function setStatus(msg) { 
    document.getElementById("statusText").textContent = msg; 
    console.log("Status:", msg);
}

function updateRecordCount(count) {
    document.getElementById("recordCount").textContent = count;
}

function ordinal(n) {
    var s = ["th", "st", "nd", "rd"], v = n % 100;
    return n + (s[(v - 20) % 10] || s[v] || s[0]);
}

function formatFancy(iso) {
    if (!iso) return "";
    var parts = iso.split("-");
    if (parts.length !== 3) return "";
    var y = parseInt(parts[0], 10), m = parseInt(parts[1], 10), d = parseInt(parts[2], 10);
    var dt = new Date(y, m - 1, d);
    var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    return ordinal(dt.getDate()) + " " + months[dt.getMonth()] + ", " + dt.getFullYear();
}

function setTodayPaymentDate() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const dateStr = `${year}-${month}-${day}`;
    
    document.getElementById("payDate").value = dateStr;
    document.getElementById("payDateFancy").textContent = formatFancy(dateStr);
}

// ==================== STORAGE FUNCTIONS ====================
// Simple LocalStorage-based storage system
class DataStorage {
    constructor() {
        this.init();
    }
    
    init() {
        // Initialize if empty
        if (!localStorage.getItem(FEE_STORAGE_KEY)) {
            localStorage.setItem(FEE_STORAGE_KEY, JSON.stringify([]));
        }
        if (!localStorage.getItem(STUDENT_STORAGE_KEY)) {
            localStorage.setItem(STUDENT_STORAGE_KEY, JSON.stringify([]));
        }
        if (!localStorage.getItem(LAST_BILL_KEY)) {
            localStorage.setItem(LAST_BILL_KEY, "BL0000");
        }
    }
    
    // ========== FEE OPERATIONS ==========
    saveFee(feeData) {
        try {
            const fees = this.getAllFees();
            const existingIndex = fees.findIndex(f => f.billNo === feeData.billNo);
            
            if (existingIndex >= 0) {
                fees[existingIndex] = feeData;
            } else {
                fees.push(feeData);
            }
            
            localStorage.setItem(FEE_STORAGE_KEY, JSON.stringify(fees));
            localStorage.setItem(LAST_BILL_KEY, feeData.billNo);
            this.updateLastUpdated();
            
            return true;
        } catch (error) {
            console.error("Error saving fee:", error);
            return false;
        }
    }
    
    getFee(billNo) {
        const fees = this.getAllFees();
        return fees.find(f => f.billNo === billNo) || null;
    }
    
    getAllFees() {
        try {
            const data = localStorage.getItem(FEE_STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        } catch (error) {
            console.error("Error getting fees:", error);
            return [];
        }
    }
    
    deleteFee(billNo) {
        try {
            const fees = this.getAllFees();
            const filtered = fees.filter(f => f.billNo !== billNo);
            localStorage.setItem(FEE_STORAGE_KEY, JSON.stringify(filtered));
            this.updateLastUpdated();
            return true;
        } catch (error) {
            console.error("Error deleting fee:", error);
            return false;
        }
    }
    
    // ========== STUDENT OPERATIONS ==========
    saveStudent(studentData) {
        try {
            const students = this.getAllStudents();
            const existingIndex = students.findIndex(s => s.studentId === studentData.studentId);
            
            if (existingIndex >= 0) {
                students[existingIndex] = studentData;
            } else {
                students.push(studentData);
            }
            
            localStorage.setItem(STUDENT_STORAGE_KEY, JSON.stringify(students));
            return true;
        } catch (error) {
            console.error("Error saving student:", error);
            return false;
        }
    }
    
    getStudent(studentId) {
        const students = this.getAllStudents();
        return students.find(s => s.studentId === studentId) || null;
    }
    
    getAllStudents() {
        try {
            const data = localStorage.getItem(STUDENT_STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        } catch (error) {
            console.error("Error getting students:", error);
            return [];
        }
    }
    
    deleteStudent(studentId) {
        try {
            const students = this.getAllStudents();
            const filtered = students.filter(s => s.studentId !== studentId);
            localStorage.setItem(STUDENT_STORAGE_KEY, JSON.stringify(filtered));
            return true;
        } catch (error) {
            console.error("Error deleting student:", error);
            return false;
        }
    }
    
    // ========== UTILITY FUNCTIONS ==========
    updateLastUpdated() {
        const now = new Date().toISOString();
        localStorage.setItem(APP_NAME + "_last_updated", now);
    }
    
    getLastUpdated() {
        const dateStr = localStorage.getItem(APP_NAME + "_last_updated");
        return dateStr ? new Date(dateStr).toLocaleString() : "Never";
    }
    
    clearAllData() {
        localStorage.removeItem(FEE_STORAGE_KEY);
        localStorage.removeItem(STUDENT_STORAGE_KEY);
        localStorage.removeItem(LAST_BILL_KEY);
        this.init();
    }
}

// Create storage instance
const storage = new DataStorage();

// ==================== BILL NUMBER GENERATION ====================
function generateNextBillNo() {
    try {
        const lastBill = localStorage.getItem(LAST_BILL_KEY) || "BL0000";
        
        if (/^BL\d{4}$/.test(lastBill)) {
            const lastNum = parseInt(lastBill.substring(2), 10);
            const nextNum = lastNum + 1;
            return "BL" + String(nextNum).padStart(4, "0");
        }
        
        // Fallback: check existing bills
        const allFees = storage.getAllFees();
        if (allFees.length === 0) {
            return "BL0001";
        }
        
        const billNumbers = allFees
            .map(f => f.billNo)
            .filter(b => /^BL\d{4}$/i.test(b))
            .map(b => parseInt(b.substring(2), 10))
            .filter(n => !isNaN(n));
        
        if (billNumbers.length === 0) {
            return "BL0001";
        }
        
        const maxNum = Math.max(...billNumbers);
        return "BL" + String(maxNum + 1).padStart(4, "0");
        
    } catch (error) {
        console.error("Error generating bill number:", error);
        // Date-based fallback
        const date = new Date();
        const dateStr = date.getFullYear().toString().slice(-2) + 
                       (date.getMonth() + 1).toString().padStart(2, '0');
        return "BL" + dateStr + "01";
    }
}

// ==================== STUDENT AUTO-COMPLETE ====================
function setupStudentAutocomplete() {
    const studentIdInput = document.getElementById('studentId');
    const studentNameInput = document.getElementById('studentName');
    const classInput = document.getElementById('className');
    const sectionInput = document.getElementById('section');
    const rollInput = document.getElementById('roll');
    
    // When student ID is entered
    studentIdInput.addEventListener('blur', async function() {
        const studentId = this.value.trim();
        if (!studentId) return;
        
        const student = storage.getStudent(studentId);
        if (student) {
            studentNameInput.value = student.studentName || '';
            classInput.value = student.className || '';
            sectionInput.value = student.section || '';
            rollInput.value = student.roll || '';
            setStatus(`Student loaded: ${student.studentName}`);
        } else {
            setStatus("Student not found. You can enter details manually.");
            // Don't clear manual entries if user already typed something
            if (!studentNameInput.value && !classInput.value) {
                // Ask if user wants to create new student
                if (confirm(`Student ID "${studentId}" not found. Create new student?`)) {
                    showStudentModal(studentId);
                }
            }
        }
        
        // Load payment history for this student
        await refreshStudentHistory(studentId);
        applyKitLocks();
    });
    
    // Manual entry button
    document.getElementById('manualStudentBtn').addEventListener('click', function() {
        const studentId = studentIdInput.value.trim();
        showStudentModal(studentId);
    });
}

// ==================== MODAL FUNCTIONS ====================
function showStudentModal(prefillId = '') {
    const modal = document.getElementById('studentModal');
    const modalStudentId = document.getElementById('modalStudentId');
    const modalStudentName = document.getElementById('modalStudentName');
    const modalClassName = document.getElementById('modalClassName');
    const modalSection = document.getElementById('modalSection');
    const modalRoll = document.getElementById('modalRoll');
    
    // Prefill with existing data if available
    modalStudentId.value = prefillId || document.getElementById('studentId').value || '';
    modalStudentName.value = document.getElementById('studentName').value || '';
    modalClassName.value = document.getElementById('className').value || '';
    modalSection.value = document.getElementById('section').value || '';
    modalRoll.value = document.getElementById('roll').value || '';
    
    modal.style.display = 'flex';
}

function hideStudentModal() {
    document.getElementById('studentModal').style.display = 'none';
}

// ==================== FORM FUNCTIONS ====================
function updateAdmissionControls() {
    const type = document.getElementById("admissionType").value;
    const amountField = document.getElementById("admissionAmount");
    const monthField = document.getElementById("installMonth");
    
    if (type === "FULL PAYMENT") {
        amountField.disabled = false;
        monthField.disabled = true;
        monthField.value = "";
    } else if (type === "INSTALLMENT") {
        amountField.disabled = false;
        monthField.disabled = false;
    } else {
        amountField.disabled = true;
        monthField.disabled = true;
        amountField.value = "0";
        monthField.value = "";
    }
}

// Kit management
function kitKey(studentId, year) {
    return `${APP_NAME}_kit_${studentId}_${year}`;
}

function getKitYearRecord(studentId, year) {
    if (!studentId || !year) return { items: [] };
    try {
        const data = localStorage.getItem(kitKey(studentId, year));
        return data ? JSON.parse(data) : { items: [] };
    } catch (e) {
        return { items: [] };
    }
}

function saveKitYearRecord(studentId, year, record) {
    if (!studentId || !year) return;
    localStorage.setItem(kitKey(studentId, year), JSON.stringify(record));
}

function applyKitLocks() {
    const studentId = document.getElementById("studentId").value.trim();
    const payDate = document.getElementById("payDate").value;
    const year = payDate ? payDate.split("-")[0] : "";
    
    if (!studentId || !year) return;
    
    const kitRecord = getKitYearRecord(studentId, year);
    const checkboxes = document.querySelectorAll(".kit-given");
    
    checkboxes.forEach(checkbox => {
        if (kitRecord.items.includes(checkbox.value)) {
            checkbox.checked = true;
            checkbox.disabled = true;
        } else {
            checkbox.disabled = false;
        }
    });
}

// Number to words
function numberToIndianWords(n) {
    n = Math.round(Number(n) || 0);
    if (n === 0) return "zero rupees";
    
    const ones = ["", "one", "two", "three", "four", "five", "six", "seven", "eight", "nine",
                  "ten", "eleven", "twelve", "thirteen", "fourteen", "fifteen",
                  "sixteen", "seventeen", "eighteen", "nineteen"];
    const tens = ["", "", "twenty", "thirty", "forty", "fifty", "sixty", "seventy", "eighty", "ninety"];
    
    function twoDigits(num) {
        if (num === 0) return "";
        if (num < 20) return ones[num];
        return tens[Math.floor(num / 10)] + (num % 10 ? " " + ones[num % 10] : "");
    }
    
    function threeDigits(num) {
        const hundred = Math.floor(num / 100);
        const rest = num % 100;
        const parts = [];
        if (hundred > 0) parts.push(ones[hundred] + " hundred");
        if (rest > 0) {
            if (parts.length) parts.push("and");
            parts.push(twoDigits(rest));
        }
        return parts.join(" ");
    }
    
    const parts = [];
    let crore = Math.floor(n / 10000000); n %= 10000000;
    let lakh = Math.floor(n / 100000); n %= 100000;
    let thousand = Math.floor(n / 1000); n %= 1000;
    let hundred = n;
    
    if (crore) parts.push(threeDigits(crore) + " crore");
    if (lakh) parts.push(threeDigits(lakh) + " lakh");
    if (thousand) parts.push(threeDigits(thousand) + " thousand");
    if (hundred) parts.push(threeDigits(hundred));
    
    return parts.join(" ") + " rupees";
}

function updateTotalInWords(total) {
    const span = document.getElementById("totalInWords");
    if (!span) return;
    
    const num = Math.round(Number(total) || 0);
    span.textContent = num ? numberToIndianWords(num) + " only" : "";
}

function calculateTotal() {
    let total = 0;
    
    const getValue = (id) => {
        const val = document.getElementById(id).value;
        return isNaN(val) ? 0 : Number(val);
    };
    
    total += getValue("admissionAmount");
    total += getValue("developmentAmount");
    total += getValue("uniformSets");
    total += getValue("tiffin");
    total += getValue("misc");
    total += getValue("picnic");
    total += getValue("fieldtrip");
    total += getValue("sports");
    
    document.getElementById("totalAmount").value = total.toFixed(2);
    updateTotalInWords(total);
}

function getKitData() {
    const givenBoxes = document.querySelectorAll(".kit-given:not(:disabled)");
    const dueBoxes = document.querySelectorAll(".kit-due");
    
    const selected = Array.from(givenBoxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    
    const due = Array.from(dueBoxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    
    return { selected, due };
}

function setKitData(selected = [], due = []) {
    const givenBoxes = document.querySelectorAll(".kit-given");
    const dueBoxes = document.querySelectorAll(".kit-due");
    
    givenBoxes.forEach(cb => {
        cb.checked = selected.includes(cb.value);
    });
    
    dueBoxes.forEach(cb => {
        cb.checked = due.includes(cb.value);
    });
    
    applyKitLocks();
}

function getFormData() {
    const kit = getKitData();
    const payDate = document.getElementById("payDate").value;
    
    let payMonth = "", payYear = "";
    const feeMonth = document.getElementById("feeMonth").value;
    const feeYear = document.getElementById("feeYear").value.trim();
    
    if (feeMonth && feeYear) {
        payMonth = feeMonth;
        payYear = feeYear;
    } else if (payDate) {
        const parts = payDate.split("-");
        if (parts.length === 3) {
            payYear = parts[0];
            payMonth = parts[1];
        }
    }
    
    // Get current form values
    const studentId = document.getElementById("studentId").value.trim();
    const studentName = document.getElementById("studentName").value.trim();
    const className = document.getElementById("className").value.trim();
    const section = document.getElementById("section").value.trim();
    const roll = document.getElementById("roll").value.trim();
    
    // Auto-save student information if not already saved
    if (studentId && studentName && className) {
        const studentData = {
            studentId: studentId,
            studentName: studentName,
            className: className,
            section: section,
            roll: roll,
            lastUpdated: new Date().toISOString()
        };
        storage.saveStudent(studentData);
    }
    
    return {
        billNo: document.getElementById("billNo").value.trim(),
        studentName: studentName,
        studentId: studentId,
        className: className,
        section: section,
        roll: roll,
        payDate: payDate,
        payMonth: payMonth,
        payYear: payYear,
        admissionType: document.getElementById("admissionType").value,
        admissionAmount: Number(document.getElementById("admissionAmount").value || 0),
        installMonth: document.getElementById("installMonth").value,
        developmentType: document.getElementById("developmentType").value,
        developmentAmount: Number(document.getElementById("developmentAmount").value || 0),
        uniformType: document.getElementById("uniformType").value,
        uniformSets: Number(document.getElementById("uniformSets").value || 0),
        kitSelected: kit.selected,
        kitDue: kit.due,
        tiffin: Number(document.getElementById("tiffin").value || 0),
        misc: Number(document.getElementById("misc").value || 0),
        picnic: Number(document.getElementById("picnic").value || 0),
        fieldtrip: Number(document.getElementById("fieldtrip").value || 0),
        sports: Number(document.getElementById("sports").value || 0),
        paymentMode: document.getElementById("paymentMode").value,
        totalAmount: Number(document.getElementById("totalAmount").value || 0),
        timestamp: new Date().toISOString()
    };
}

function fillForm(data) {
    document.getElementById("billNo").value = data.billNo || "";
    document.getElementById("studentName").value = data.studentName || "";
    document.getElementById("studentId").value = data.studentId || "";
    document.getElementById("className").value = data.className || "";
    document.getElementById("section").value = data.section || "";
    document.getElementById("roll").value = data.roll || "";
    document.getElementById("payDate").value = data.payDate || "";
    document.getElementById("payDateFancy").textContent = formatFancy(data.payDate || "");
    document.getElementById("feeMonth").value = data.payMonth || "";
    document.getElementById("feeYear").value = data.payYear || "";
    document.getElementById("admissionType").value = data.admissionType || "";
    document.getElementById("admissionAmount").value = data.admissionAmount || 0;
    document.getElementById("installMonth").value = data.installMonth || "";
    document.getElementById("developmentType").value = data.developmentType || "";
    document.getElementById("developmentAmount").value = data.developmentAmount || 0;
    document.getElementById("uniformType").value = data.uniformType || "";
    document.getElementById("uniformSets").value = data.uniformSets || 0;
    
    setKitData(data.kitSelected || [], data.kitDue || []);
    
    document.getElementById("tiffin").value = data.tiffin || 0;
    document.getElementById("misc").value = data.misc || 0;
    document.getElementById("picnic").value = data.picnic || 0;
    document.getElementById("fieldtrip").value = data.fieldtrip || 0;
    document.getElementById("sports").value = data.sports || 0;
    document.getElementById("paymentMode").value = data.paymentMode || "CASH";
    document.getElementById("totalAmount").value = data.totalAmount || 0;
    
    updateTotalInWords(data.totalAmount || 0);
    updateAdmissionControls();
    calculateTotal();
    applyKitLocks();
}

async function clearForm() {
    // Generate new bill number
    const nextBillNo = generateNextBillNo();
    document.getElementById("billNo").value = nextBillNo;
    
    // Clear only student ID, keep other student info for manual editing
    document.getElementById("studentId").value = "";
    
    // Reset fee fields only
    document.getElementById("feeMonth").value = "";
    document.getElementById("feeYear").value = new Date().getFullYear();
    document.getElementById("admissionType").value = "";
    document.getElementById("admissionAmount").value = "0";
    document.getElementById("installMonth").value = "";
    document.getElementById("developmentType").value = "";
    document.getElementById("developmentAmount").value = "0";
    document.getElementById("uniformType").value = "";
    document.getElementById("uniformSets").value = "0";
    document.getElementById("tiffin").value = "0";
    document.getElementById("misc").value = "0";
    document.getElementById("picnic").value = "0";
    document.getElementById("fieldtrip").value = "0";
    document.getElementById("sports").value = "0";
    document.getElementById("totalAmount").value = "0";
    document.getElementById("paymentMode").value = "CASH";
    
    // Set today's date
    setTodayPaymentDate();
    
    // Reset kit checkboxes
    setKitData([], []);
    
    updateTotalInWords(0);
    updateAdmissionControls();
    calculateTotal();
    
    setStatus(`New bill created: ${nextBillNo}`);
}

// ==================== DATA MANAGEMENT ====================
let currentIndex = -1;
let allFeesCache = [];

async function refreshTable() {
    try {
        allFeesCache = storage.getAllFees();
        
        // Update statistics
        document.getElementById("totalRecords").textContent = allFeesCache.length;
        updateRecordCount(allFeesCache.length);
        
        const totalAmount = allFeesCache.reduce((sum, fee) => sum + (fee.totalAmount || 0), 0);
        document.getElementById("totalAmountSum").textContent = totalAmount.toLocaleString('en-IN');
        
        document.getElementById("lastUpdated").textContent = storage.getLastUpdated();
        
        // Apply filters
        const nameFilter = document.getElementById("filterName").value.toLowerCase();
        const idFilter = document.getElementById("filterId").value.toLowerCase();
        const classFilter = document.getElementById("filterClass").value.toLowerCase();
        const monthFilter = document.getElementById("filterMonth").value;
        const yearFilter = document.getElementById("filterYear").value.trim();
        
        const filtered = allFeesCache.filter(fee => {
            if (nameFilter && !fee.studentName?.toLowerCase().includes(nameFilter)) return false;
            if (idFilter && !fee.studentId?.toLowerCase().includes(idFilter)) return false;
            if (classFilter && !fee.className?.toLowerCase().includes(classFilter)) return false;
            if (monthFilter && fee.payMonth !== monthFilter) return false;
            if (yearFilter && String(fee.payYear) !== yearFilter) return false;
            return true;
        });
        
        // Sort by bill number
        filtered.sort((a, b) => a.billNo.localeCompare(b.billNo));
        
        // Update table
        const tbody = document.getElementById("feeTableBody");
        tbody.innerHTML = "";
        
        const months = ["January", "February", "March", "April", "May", "June", 
                       "July", "August", "September", "October", "November", "December"];
        
        if (filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="19" style="text-align:center;padding:20px;color:#666;">No fee records found. Save your first fee entry!</td></tr>`;
        } else {
            filtered.forEach(fee => {
                const monthName = fee.payMonth ? 
                    months[parseInt(fee.payMonth, 10) - 1] || fee.payMonth : "";
                
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td><strong>${fee.billNo || ""}</strong></td>
                    <td>${fee.studentId || ""}</td>
                    <td>${fee.studentName || ""}</td>
                    <td>${fee.className || ""}</td>
                    <td>${monthName}</td>
                    <td>${fee.payYear || ""}</td>
                    <td>${fee.admissionAmount || 0}</td>
                    <td>${fee.developmentAmount || 0}</td>
                    <td>${fee.uniformSets || 0}</td>
                    <td>${fee.tiffin || 0}</td>
                    <td>${fee.misc || 0}</td>
                    <td>${fee.picnic || 0}</td>
                    <td>${fee.fieldtrip || 0}</td>
                    <td>${fee.sports || 0}</td>
                    <td><strong>‚Çπ${(fee.totalAmount || 0).toLocaleString('en-IN')}</strong></td>
                    <td>${fee.paymentMode || ""}</td>
                    <td><button class="small-btn sb-print" data-bill="${fee.billNo}" title="Print">üñ®Ô∏è</button></td>
                    <td><button class="small-btn sb-edit" data-bill="${fee.billNo}" title="Edit">‚úèÔ∏è</button></td>
                    <td><button class="small-btn sb-del" data-bill="${fee.billNo}" title="Delete">üóëÔ∏è</button></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        setStatus(`Loaded ${filtered.length} fee records`);
        
    } catch (error) {
        console.error("Error refreshing table:", error);
        setStatus("Error loading records");
    }
}

async function refreshStudentHistory(studentId) {
    const tbody = document.getElementById("studentHistoryBody");
    tbody.innerHTML = "";
    
    if (!studentId) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#666;">Enter Student ID to view history</td></tr>`;
        return;
    }
    
    try {
        const allFees = storage.getAllFees();
        const studentFees = allFees
            .filter(fee => fee.studentId === studentId)
            .sort((a, b) => (a.payDate || "").localeCompare(b.payDate || ""));
        
        if (studentFees.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#666;">No payment history for this student</td></tr>`;
            return;
        }
        
        studentFees.forEach(fee => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td><strong>${fee.billNo || ""}</strong></td>
                <td>${formatFancy(fee.payDate || "")}</td>
                <td><strong>‚Çπ${(fee.totalAmount || 0).toLocaleString('en-IN')}</strong></td>
                <td>${fee.paymentMode || ""}</td>
                <td><button class="small-btn sb-view" data-bill="${fee.billNo}" title="View Details">üëÅÔ∏è</button></td>
            `;
            tbody.appendChild(row);
        });
    } catch (error) {
        console.error("Error refreshing student history:", error);
    }
}

function addSampleData() {
    // Sample students
    const sampleStudents = [
        {
            studentId: "ST001",
            studentName: "RAHUL SHARMA",
            className: "CLASS - I",
            section: "A",
            roll: "1",
            parentName: "MR. SHARMA",
            contact: "9876543210"
        },
        {
            studentId: "ST002",
            studentName: "PRIYA PATEL",
            className: "CLASS - II",
            section: "B",
            roll: "5",
            parentName: "MRS. PATEL",
            contact: "9876543211"
        },
        {
            studentId: "ST003",
            studentName: "AMIT KUMAR",
            className: "CLASS - III",
            section: "A",
            roll: "3",
            parentName: "MR. KUMAR",
            contact: "9876543212"
        }
    ];
    
    // Save sample students
    sampleStudents.forEach(student => {
        storage.saveStudent(student);
    });
    
    // Sample fee records
    const sampleFees = [
        {
            billNo: "BL0001",
            studentId: "ST001",
            studentName: "RAHUL SHARMA",
            className: "CLASS - I",
            section: "A",
            roll: "1",
            payDate: "2025-01-15",
            payMonth: "01",
            payYear: "2025",
            admissionType: "FULL PAYMENT",
            admissionAmount: 1500,
            developmentAmount: 500,
            uniformSets: 2,
            tiffin: 300,
            misc: 100,
            totalAmount: 2400,
            paymentMode: "CASH",
            timestamp: new Date().toISOString()
        },
        {
            billNo: "BL0002",
            studentId: "ST002",
            studentName: "PRIYA PATEL",
            className: "CLASS - II",
            section: "B",
            roll: "5",
            payDate: "2025-01-20",
            payMonth: "01",
            payYear: "2025",
            admissionType: "INSTALLMENT",
            admissionAmount: 750,
            developmentAmount: 600,
            uniformSets: 1,
            tiffin: 300,
            totalAmount: 1650,
            paymentMode: "ONLINE",
            timestamp: new Date().toISOString()
        }
    ];
    
    // Save sample fees
    sampleFees.forEach(fee => {
        storage.saveFee(fee);
    });
    
    localStorage.setItem(LAST_BILL_KEY, "BL0002");
    
    alert("‚úÖ Sample data added successfully!\n\nAdded:\n- 3 Sample Students\n- 2 Sample Fee Records");
    
    refreshTable();
    setStatus("Sample data loaded");
}

// ==================== EVENT HANDLERS ====================
document.addEventListener("DOMContentLoaded", function() {
    try {
        // Initialize storage
        storage.init();
        
        // Set today's date
        setTodayPaymentDate();
        
        // Generate initial bill number
        const nextBillNo = generateNextBillNo();
        document.getElementById("billNo").value = nextBillNo;
        
        // Set current year
        const currentYear = new Date().getFullYear();
        document.getElementById("feeYear").value = currentYear;
        
        // Setup event listeners
        setupEventListeners();
        
        // Setup student autocomplete
        setupStudentAutocomplete();
        
        // Load initial data
        refreshTable();
        
        setStatus(`Ready! Start by entering Student ID or using Manual Entry.`);
        
    } catch (error) {
        console.error("Initialization error:", error);
        setStatus("Error initializing application");
    }
});

function setupEventListeners() {
    // Modal buttons
    document.getElementById('modalCancelBtn').addEventListener('click', hideStudentModal);
    document.getElementById('modalSaveBtn').addEventListener('click', function() {
        const studentData = {
            studentId: document.getElementById('modalStudentId').value.trim(),
            studentName: document.getElementById('modalStudentName').value.trim(),
            className: document.getElementById('modalClassName').value.trim(),
            section: document.getElementById('modalSection').value.trim(),
            roll: document.getElementById('modalRoll').value.trim(),
            parentName: document.getElementById('modalParentName').value.trim(),
            contact: document.getElementById('modalContact').value.trim(),
            createdAt: new Date().toISOString()
        };
        
        if (!studentData.studentId || !studentData.studentName || !studentData.className) {
            alert("Please fill at least Student ID, Name, and Class");
            return;
        }
        
        if (storage.saveStudent(studentData)) {
            // Update form fields
            document.getElementById('studentId').value = studentData.studentId;
            document.getElementById('studentName').value = studentData.studentName;
            document.getElementById('className').value = studentData.className;
            document.getElementById('section').value = studentData.section;
            document.getElementById('roll').value = studentData.roll;
            
            hideStudentModal();
            setStatus(`Student "${studentData.studentName}" saved successfully`);
            
            // Load payment history
            refreshStudentHistory(studentData.studentId);
        } else {
            alert("Error saving student");
        }
    });
    
    // Date change
    document.getElementById("payDate").addEventListener("change", function() {
        document.getElementById("payDateFancy").textContent = formatFancy(this.value);
        applyKitLocks();
    });
    
    // Admission type change
    document.getElementById("admissionType").addEventListener("change", updateAdmissionControls);
    
    // Calculate total on input
    ["admissionAmount", "developmentAmount", "uniformSets", "tiffin", "misc", "picnic", "fieldtrip", "sports"]
        .forEach(id => {
            document.getElementById(id).addEventListener("input", calculateTotal);
        });
    
    // Save button
    document.getElementById("saveBtn").addEventListener("click", function() {
        const formData = getFormData();
        
        // Validation
        if (!formData.studentId) {
            alert("‚ùå Please enter Student ID");
            document.getElementById("studentId").focus();
            return;
        }
        
        if (!formData.studentName) {
            alert("‚ùå Please enter Student Name");
            document.getElementById("studentName").focus();
            return;
        }
        
        if (!formData.className) {
            alert("‚ùå Please enter Class");
            document.getElementById("className").focus();
            return;
        }
        
        if (!formData.payMonth || !formData.payYear) {
            alert("‚ùå Please select Month and Year");
            return;
        }
        
        // Ensure bill number exists
        if (!formData.billNo || formData.billNo === "BL0001") {
            formData.billNo = generateNextBillNo();
            document.getElementById("billNo").value = formData.billNo;
        }
        
        // Calculate final total
        calculateTotal();
        formData.totalAmount = Number(document.getElementById("totalAmount").value || 0);
        
        if (formData.totalAmount <= 0) {
            if (!confirm("Total amount is 0. Save anyway?")) {
                return;
            }
        }
        
        // Save kit items
        const kitRecord = getKitYearRecord(formData.studentId, formData.payYear);
        formData.kitSelected.forEach(item => {
            if (!kitRecord.items.includes(item)) {
                kitRecord.items.push(item);
            }
        });
        saveKitYearRecord(formData.studentId, formData.payYear, kitRecord);
        
        if (storage.saveFee(formData)) {
            alert(`‚úÖ Fee saved successfully!\n\nBill: ${formData.billNo}\nStudent: ${formData.studentName}\nAmount: ‚Çπ${formData.totalAmount}\nDate: ${formatFancy(formData.payDate)}`);
            
            clearForm();
            refreshTable();
            refreshStudentHistory(formData.studentId);
            
            setStatus(`Saved ${formData.billNo} for ${formData.studentName}`);
            
        } else {
            alert("‚ùå Error saving fee");
        }
    });
    
    // Edit button
    document.getElementById("editBtn").addEventListener("click", function() {
        const billNo = prompt("Enter Bill Number to edit:", document.getElementById("billNo").value);
        if (!billNo) return;
        
        const fee = storage.getFee(billNo.trim());
        if (!fee) {
            alert("Bill not found");
            return;
        }
        
        fillForm(fee);
        setStatus(`Editing: ${billNo}`);
        refreshStudentHistory(fee.studentId);
    });
    
    // Delete button
    document.getElementById("deleteBtn").addEventListener("click", function() {
        const billNo = document.getElementById("billNo").value.trim();
        if (!billNo || billNo === "BL0001") {
            alert("No bill selected to delete");
            return;
        }
        
        if (!confirm(`Delete bill ${billNo}? This cannot be undone.`)) {
            return;
        }
        
        if (storage.deleteFee(billNo)) {
            alert(`Deleted bill ${billNo}`);
            
            clearForm();
            refreshTable();
            refreshStudentHistory(document.getElementById("studentId").value);
            
            setStatus(`Deleted ${billNo}`);
            
        } else {
            alert("Error deleting bill");
        }
    });
    
    // Search button
    document.getElementById("searchBtn").addEventListener("click", function() {
        const billNo = document.getElementById("searchBill").value.trim();
        if (!billNo) {
            alert("Enter bill number");
            return;
        }
        
        const fee = storage.getFee(billNo);
        if (!fee) {
            alert("Bill not found");
            return;
        }
        
        fillForm(fee);
        setStatus(`Found: ${billNo}`);
        refreshStudentHistory(fee.studentId);
    });
    
    // Navigation buttons
    document.getElementById("prevBtn").addEventListener("click", function() {
        if (allFeesCache.length === 0) {
            alert("No records available");
            return;
        }
        
        if (currentIndex > 0) {
            currentIndex--;
            fillForm(allFeesCache[currentIndex]);
            refreshStudentHistory(allFeesCache[currentIndex].studentId);
            setStatus(`Record ${currentIndex + 1} of ${allFeesCache.length}`);
        } else {
            alert("First record");
        }
    });
    
    document.getElementById("nextBtn").addEventListener("click", function() {
        if (allFeesCache.length === 0) {
            alert("No records available");
            return;
        }
        
        if (currentIndex < allFeesCache.length - 1) {
            currentIndex++;
            fillForm(allFeesCache[currentIndex]);
            refreshStudentHistory(allFeesCache[currentIndex].studentId);
            setStatus(`Record ${currentIndex + 1} of ${allFeesCache.length}`);
        } else {
            alert("Last record");
        }
    });
    
    // Filter buttons
    document.getElementById("filterApply").addEventListener("click", refreshTable);
    document.getElementById("filterReset").addEventListener("click", function() {
        document.getElementById("filterName").value = "";
        document.getElementById("filterId").value = "";
        document.getElementById("filterClass").value = "";
        document.getElementById("filterMonth").value = "";
        document.getElementById("filterYear").value = "";
        refreshTable();
    });
    
    // Table button clicks
    document.getElementById("feeTableBody").addEventListener("click", function(e) {
        const button = e.target;
        if (!button.classList.contains("small-btn")) return;
        
        const billNo = button.getAttribute("data-bill");
        if (!billNo) return;
        
        const fee = storage.getFee(billNo);
        if (!fee) return;
        
        if (button.classList.contains("sb-edit")) {
            fillForm(fee);
            setStatus(`Loaded ${billNo} for editing`);
            refreshStudentHistory(fee.studentId);
            
        } else if (button.classList.contains("sb-del")) {
            if (confirm(`Delete ${billNo}?`)) {
                storage.deleteFee(billNo);
                refreshTable();
                refreshStudentHistory(fee.studentId);
                setStatus(`Deleted ${billNo}`);
            }
            
        } else if (button.classList.contains("sb-print")) {
            window.open(`print_fee.html?bill=${billNo}`, "_blank");
        }
    });
    
    // Student history table clicks
    document.getElementById("studentHistoryBody").addEventListener("click", function(e) {
        const button = e.target;
        if (!button.classList.contains("sb-view")) return;
        
        const billNo = button.getAttribute("data-bill");
        if (!billNo) return;
        
        const fee = storage.getFee(billNo);
        if (!fee) return;
        
        fillForm(fee);
        setStatus(`Viewing: ${billNo}`);
    });
    
    // CSV Export
    document.getElementById("csvExportBtn").addEventListener("click", function() {
        try {
            const fees = storage.getAllFees();
            if (fees.length === 0) {
                alert("No data to export");
                return;
            }
            
            const headers = ["Bill No", "Student ID", "Student Name", "Class", "Section", "Roll", 
                           "Payment Date", "Month", "Year", "Admission Type", "Admission Amount", 
                           "Install Month", "Development Type", "Development Amount", "Uniform Type", 
                           "Uniform Sets", "Tiffin", "Misc", "Picnic", "Field Trip", "Sports", 
                           "Payment Mode", "Total Amount"];
            
            const months = ["January", "February", "March", "April", "May", "June", 
                          "July", "August", "September", "October", "November", "December"];
            
            let csvContent = headers.join(",") + "\n";
            
            fees.forEach(fee => {
                const monthName = fee.payMonth ? 
                    months[parseInt(fee.payMonth, 10) - 1] || fee.payMonth : "";
                
                const row = [
                    `"${fee.billNo || ""}"`,
                    `"${fee.studentId || ""}"`,
                    `"${fee.studentName || ""}"`,
                    `"${fee.className || ""}"`,
                    `"${fee.section || ""}"`,
                    `"${fee.roll || ""}"`,
                    `"${fee.payDate || ""}"`,
                    `"${monthName}"`,
                    `"${fee.payYear || ""}"`,
                    `"${fee.admissionType || ""}"`,
                    fee.admissionAmount || 0,
                    `"${fee.installMonth || ""}"`,
                    `"${fee.developmentType || ""}"`,
                    fee.developmentAmount || 0,
                    `"${fee.uniformType || ""}"`,
                    fee.uniformSets || 0,
                    fee.tiffin || 0,
                    fee.misc || 0,
                    fee.picnic || 0,
                    fee.fieldtrip || 0,
                    fee.sports || 0,
                    `"${fee.paymentMode || ""}"`,
                    fee.totalAmount || 0
                ];
                
                csvContent += row.join(",") + "\n";
            });
            
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `fee_records_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            setStatus(`Exported ${fees.length} records to CSV`);
            
        } catch (error) {
            console.error("CSV export error:", error);
            alert("Error exporting CSV");
        }
    });
    
    // Student Report
    document.getElementById("studentReportBtn").addEventListener("click", function() {
        try {
            const fees = storage.getAllFees();
            if (fees.length === 0) {
                alert("No student records found");
                return;
            }
            
            // Group by student
            const students = {};
            fees.forEach(fee => {
                const sid = fee.studentId;
                if (!students[sid]) {
                    students[sid] = {
                        id: sid,
                        name: fee.studentName,
                        className: fee.className,
                        section: fee.section,
                        roll: fee.roll,
                        totalPaid: 0,
                        payments: [],
                        billCount: 0
                    };
                }
                students[sid].totalPaid += (fee.totalAmount || 0);
                students[sid].billCount++;
                students[sid].payments.push({
                    billNo: fee.billNo,
                    date: formatFancy(fee.payDate),
                    amount: fee.totalAmount,
                    mode: fee.paymentMode
                });
            });
            
            const studentList = Object.values(students).sort((a, b) => b.totalPaid - a.totalPaid);
            
            // Generate report HTML
            const reportHTML = `
<!DOCTYPE html>
<html>
<head>
    <title>Student Fee Report - Chatushpathi Foundation</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f5f5f5; }
        .header { background: #2e7d32; color: white; padding: 20px; text-align: center; border-radius: 10px; }
        .student { background: white; margin: 20px 0; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .student-header { background: #e8f5e9; padding: 15px; border-radius: 5px; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f1f8e9; }
        .total { font-size: 24px; font-weight: bold; color: #2e7d32; }
        @media print {
            body { background: white; }
            .student { box-shadow: none; border: 1px solid #ddd; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä STUDENT FEE REPORT</h1>
        <h3>Chatushpathi Foundation</h3>
        <p>Generated on ${new Date().toLocaleDateString('en-IN')} at ${new Date().toLocaleTimeString('en-IN')}</p>
    </div>
    <div style="text-align:center; margin:20px; padding:20px; background:#e3f2fd; border-radius:10px;">
        <h2>Total Students: ${studentList.length}</h2>
        <h1 class="total">Grand Total: ‚Çπ${studentList.reduce((sum, s) => sum + s.totalPaid, 0).toLocaleString('en-IN')}</h1>
    </div>
    ${studentList.map((student, idx) => `
    <div class="student">
        <div class="student-header">
            <h2>${idx + 1}. ${student.name || 'Unknown'} (${student.id})</h2>
            <p>Class: ${student.className || ''} | Section: ${student.section || ''} | Roll: ${student.roll || ''}</p>
            <p style="font-size: 20px; font-weight: bold; color: #2e7d32;">
                Total Paid: ‚Çπ${student.totalPaid.toLocaleString('en-IN')} (${student.billCount} bills)
            </p>
        </div>
        <table>
            <tr>
                <th>Bill No</th>
                <th>Date</th>
                <th>Amount</th>
                <th>Payment Mode</th>
            </tr>
            ${student.payments.map(p => `
            <tr>
                <td>${p.billNo}</td>
                <td>${p.date}</td>
                <td>‚Çπ${p.amount.toLocaleString('en-IN')}</td>
                <td>${p.mode}</td>
            </tr>
            `).join('')}
            <tr style="background: #fff3e0;">
                <td colspan="2"><strong>Total</strong></td>
                <td colspan="2"><strong>‚Çπ${student.totalPaid.toLocaleString('en-IN')}</strong></td>
            </tr>
        </table>
    </div>
    `).join('')}
    <div style="text-align:center; margin-top:30px; padding:20px; background:#f5f5f5;">
        <p>Report generated by Chatushpathi Foundation Fee Collection System</p>
        <p>True education uplifts the self</p>
    </div>
</body>
</html>`;
            
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
            
            setStatus(`Generated report for ${studentList.length} students`);
            
        } catch (error) {
            console.error("Report error:", error);
            alert("Error generating report");
        }
    });
    
    // Backup data
    document.getElementById("backupBtn").addEventListener("click", function() {
        try {
            const fees = storage.getAllFees();
            const students = storage.getAllStudents();
            
            const backupData = {
                app: "Chatushpathi Fee System",
                version: "2.0",
                timestamp: new Date().toISOString(),
                feeCount: fees.length,
                studentCount: students.length,
                fees: fees,
                students: students
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `chatushpathi_backup_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            setStatus(`Backup created with ${fees.length} fees and ${students.length} students`);
            
        } catch (error) {
            console.error("Backup error:", error);
            alert("Error creating backup");
        }
    });
    
    // Add sample data button
    document.getElementById("addSampleBtn").addEventListener("click", function() {
        if (confirm("Add sample students and fee records? This will help you test the system.")) {
            addSampleData();
        }
    });
    
    // Print button
    document.getElementById("printBtn").addEventListener("click", function() {
        const billNo = document.getElementById("billNo").value.trim();
        if (!billNo || billNo === "BL0001") {
            alert("Please save the bill first before printing");
            return;
        }
        window.open(`print_fee.html?bill=${billNo}`, "_blank");
    });
    
    // Navigation buttons
    document.getElementById("homeBtn").addEventListener("click", function() {
        if (confirm("Go to Home page?")) {
            window.location.href = "index.html";
        }
    });
    
    document.getElementById("studentBtn").addEventListener("click", function() {
        if (confirm("Go to Student Management page?")) {
            window.location.href = "student.html";
        }
    });
}

// Auto-calculate total when page loads
window.addEventListener('load', function() {
    calculateTotal();
    updateAdmissionControls();
    
    // Check if there's any data
    const fees = storage.getAllFees();
    const students = storage.getAllStudents();
    
    if (fees.length === 0 && students.length === 0) {
        setStatus("Welcome! No data found. You can start by adding sample data or creating your first student.");
    }
});
</script>
</body>
</html>
