<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fee Receipt – Print</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family: Arial, sans-serif;
  margin:20px;
  color:#000;
}

h1,h2,h3,h4{
  text-align:center;
  margin:5px 0;
}

.section{
  border:1px solid #ccc;
  padding:15px;
  margin-bottom:20px;
  border-radius:6px;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:14px;
}
table, th, td{
  border:1px solid #ccc;
  padding:6px;
}
th{
  background:#f1f1f1;
}

.back-btn{
  padding:8px 18px;
  background:#1976d2;
  color:#fff;
  border:none;
  border-radius:4px;
  cursor:pointer;
  font-weight:bold;
}

header{
  text-align:center;
  margin-bottom:15px;
}
header img{
  width:70px;
  height:70px;
}

@media print{
  .no-print{ display:none !important; }
  @page { margin:10mm; }
  .page-break{ page-break-before: always; }
}
</style>
</head>
<body>

<!-- TOP BUTTONS (screen only) -->
<button class="no-print back-btn" onclick="window.location.href='fee.html'">← BACK</button>
<button class="no-print back-btn" style="background:#2e7d32;margin-left:10px;" onclick="window.print()">
PRINT NOW
</button>

<!-- COMMON HEADER WITH LOGO -->
<header>
  <img src="logo.png" alt="Logo">
  <h2>CHATUSHPATHI FOUNDATION</h2>
  <h4>True education uplifts the self</h4>
</header>

<!-- ========== PAGE 1 : BILL + STUDENT + KIT ========== -->

<div id="billSection" class="section">
  <h3>Fee Receipt</h3>
  <div id="billContent">Loading...</div>
</div>

<div id="studentSection" class="section">
  <h3>Student Information</h3>
  <div id="studentContent">Loading...</div>
</div>

<div id="kitSection" class="section">
  <h3>SCHOOL KIT (DELIVERED)</h3>
  <div id="kitContent">Loading...</div>
</div>

<!-- ========== PAGE 2+ : PAYMENT HISTORY ONLY ========== -->

<div id="historySection" class="section page-break">
  <h3>Payment History</h3>
  <div id="historyHeader"></div>
  <table>
    <thead>
      <tr>
        <th>Bill No</th>
        <th>Date</th>
        <th>Total</th>
        <th>Mode</th>
      </tr>
    </thead>
    <tbody id="historyBody">
      <tr><td colspan="4">Loading...</td></tr>
    </tbody>
  </table>
</div>

<script>
// ---------------- Number to Words (simple English) ----------------
function numberToWords(num){
  num = Math.round(Number(num) || 0);
  if(num === 0) return "zero";

  const a = ["","one","two","three","four","five","six","seven","eight","nine","ten",
             "eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"];
  const b = ["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];

  function inWords(n){
    if(n < 20) return a[n];
    if(n < 100) return b[Math.floor(n/10)] + (n%10 ? " " + a[n%10] : "");
    if(n < 1000) return a[Math.floor(n/100)] + " hundred" + (n%100 ? " " + inWords(n%100) : "");
    if(n < 1000000) return inWords(Math.floor(n/1000)) + " thousand" + (n%1000 ? " " + inWords(n%1000) : "");
    if(n < 1000000000) return inWords(Math.floor(n/1000000)) + " million" + (n%1000000 ? " " + inWords(n%1000000) : "");
    return n.toString();
  }
  return inWords(num);
}

// ---------------- DB OPEN ----------------
function openFeeDb(){
  return new Promise(resolve=>{
    const req=indexedDB.open("feeDB_v2",1);
    req.onsuccess=()=>resolve(req.result);
  });
}
function openStudDb(){
  return new Promise(resolve=>{
    const req=indexedDB.open("schoolDB_v1",1);
    req.onsuccess=()=>resolve(req.result);
  });
}

// Global info for reuse in history header
let gStudentName = "";
let gStudentClass = "";
let gStudentId    = "";

// ---------------- LOAD BILL + FIRST PAGE ----------------
async function loadBill(){
  const bill=new URLSearchParams(window.location.search).get("bill");
  if(!bill){
    document.getElementById("billContent").innerHTML="Bill not found";
    return;
  }

  const db=await openFeeDb();
  const tx=db.transaction("fees","readonly");
  const req=tx.objectStore("fees").get(bill);

  req.onsuccess=()=>{
    const r=req.result;
    if(!r){
      document.getElementById("billContent").innerHTML="No data";
      return;
    }

    gStudentName = r.studentName || "";
    gStudentClass = r.className || "";
    gStudentId = r.studentId || "";

    const total = Number(r.totalAmount || 0);
    const totalWords = numberToWords(total) + " only";

    // BILL DETAILS + TOTAL IN WORDS
    document.getElementById("billContent").innerHTML=`
      <b>Bill No:</b> ${r.billNo}<br>
      <b>Date:</b> ${r.payDate}<br>
      <b>Student ID:</b> ${r.studentId}<br>
      <b>Name:</b> ${r.studentName}<br>
      <b>Class:</b> ${r.className}<br><br>

      <table>
        <tr><th>Particular</th><th>Amount</th></tr>
        <tr><td>Admission</td><td>${r.admissionAmount}</td></tr>
        <tr><td>Development</td><td>${r.developmentAmount}</td></tr>
        <tr><td>Tiffin</td><td>${r.tiffin}</td></tr>
        <tr><td>Misc</td><td>${r.misc}</td></tr>
        <tr><td>Picnic</td><td>${r.picnic}</td></tr>
        <tr><td>Field Trip</td><td>${r.fieldtrip}</td></tr>
        <tr><td>Sports</td><td>${r.sports}</td></tr>
        <tr><th>Total</th><th>${total.toFixed(2)}</th></tr>
      </table>
      <br>
      <b>Total (in words):</b> ${totalWords}
    `;

    loadStudent(r.studentId);
    loadKit(r);
    loadHistory(r.studentId);
  };
}

// ---------------- STUDENT INFO (stay on page–1) ----------------
async function loadStudent(id){
  const db=await openStudDb();
  const tx=db.transaction("students","readonly");
  const req=tx.objectStore("students").get(id);

  req.onsuccess=()=>{
    const s=req.result;
    if(!s){
      document.getElementById("studentContent").innerHTML="Not found";
      return;
    }
    document.getElementById("studentContent").innerHTML=`
      <b>Name:</b> ${s.studentName}<br>
      <b>Class:</b> ${s.className}<br>
      <b>Section:</b> ${s.section}<br>
      <b>Roll:</b> ${s.roll}<br>
      <b>Mobile:</b> ${s.contact}<br>
      <b>Father:</b> ${s.fatherName}<br>
      <b>Mother:</b> ${s.motherName}<br>
      <b>Address:</b> ${s.address}<br>
    `;
  };
}

// ---------------- KIT (stay on page–1) ----------------
function loadKit(r){
  const delivered = (r.kitSelected && r.kitSelected.length)
    ? r.kitSelected.join(", ")
    : "No items delivered";

  document.getElementById("kitContent").innerHTML = delivered;
}

// ---------------- HISTORY (page–2 থেকে শুরু) ----------------
async function loadHistory(studentId){
  const db=await openFeeDb();
  const tx=db.transaction("fees","readonly");
  const req=tx.objectStore("fees").getAll();

  req.onsuccess=()=>{
    const list=req.result.filter(i=>i.studentId===studentId);
    list.sort((a,b)=>a.payDate.localeCompare(b.payDate));

    // History header: ছোট করে নাম/ক্লাস/আইডি আবার
    document.getElementById("historyHeader").innerHTML = `
      <b>Name:</b> ${gStudentName} &nbsp;&nbsp;
      <b>Class:</b> ${gStudentClass} &nbsp;&nbsp;
      <b>ID:</b> ${gStudentId}
    `;

    const body=document.getElementById("historyBody");
    body.innerHTML="";

    if(!list.length){
      body.innerHTML = '<tr><td colspan="4">No previous payments</td></tr>';
      return;
    }

    list.forEach(r=>{
      const row=document.createElement("tr");
      row.innerHTML=`
        <td>${r.billNo}</td>
        <td>${r.payDate}</td>
        <td>${r.totalAmount}</td>
        <td>${r.paymentMode}</td>
      `;
      body.appendChild(row);
    });
  };
}

// START
loadBill();
</script>

</body>
</html>
