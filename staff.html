<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Staff Detail (PWA â€“ Final Version)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="theme-color" content="#004d40" />
<link rel="manifest" href="manifest.json">

<style>
  body{
    font-family: Arial, sans-serif;
    max-width: 900px;
    margin:0 auto;
    padding:20px;
    background:linear-gradient(135deg,#e8f5e9,#e3f2fd);
  }
  h1{ text-align:center; color:#004d40; }
  .status-bar{
    padding:6px 12px;
    background:#c8e6c9;
    color:#1b5e20;
    border-radius:6px;
    font-size:12px;
    margin-bottom:10px;
  }
  .card{
    background:#fff;
    padding:20px;
    border-radius:8px;
    position:relative;
    box-shadow:0 2px 8px rgba(0,0,0,0.2);
  }
  form{
    display:grid;
    grid-template-columns:1fr 2fr;
    gap:10px 15px;
  }
  label{ font-weight:bold; color:#1b5e20; }
  input,select,textarea{
    width:100%; padding:6px 8px; box-sizing:border-box;
    border-radius:4px; border:1px solid #b2dfdb;
  }
  textarea{ resize:vertical; }
  #preview{
    max-width:110px; max-height:130px;
    object-fit:cover; position:absolute;
    right:20px; top:20px;
    border-radius:6px; border:1px solid #80cbc4;
  }
  .full-row{ grid-column:1/3; }

  .toolbar{
    display:flex; flex-wrap:wrap;
    gap:10px; margin-top:20px;
  }
  .btn{
    padding:8px 14px; border:none;
    border-radius:4px; color:#fff;
    font-weight:600; cursor:pointer;
    box-shadow:0 2px 4px rgba(0,0,0,0.2);
  }
  .btn-add{background:#2e7d32;}
  .btn-edit{background:#0277bd;}
  .btn-delete{background:#c62828;}
  .btn-home{background:#6a1b9a;}
  .btn-csv{background:#00897b;}
  .btn-print{background:#ef6c00;}
  .btn-prev{background:#5d4037;}
  .btn-next{background:#00796b;}
  .btn-search{background:#1e88e5;}
  .btn-test{background:#ff9800;}

  .search-box{ display:flex; gap:6px; align-items:center; }

  @media(max-width:600px){
    form{ grid-template-columns:1fr; }
    .full-row{ grid-column:1/2; }
    #preview{ position:static; margin-bottom:10px; }
    .toolbar{ flex-direction:column; align-items:flex-start; }
  }

  @media print{
    .toolbar,.status-bar{display:none;}
  }
</style>
</head>
<body>

<h1>Staff Detail (FINAL)</h1>

<div class="status-bar">Status: <span id="statusText">Loading...</span></div>

<div class="card">

<img id="preview">

<form id="staffForm">

  <label>STAFF NAME:</label>
  <input type="text" id="staffName">

  <label>PICTURE:</label>
  <input type="file" id="staffPicture" accept="image/*">

  <label>STAFF ID:</label>
  <input type="text" id="staffId" readonly>

  <label>DOB:</label>
  <input type="date" id="dob">

  <label>DOB (Formatted):</label>
  <span class="full-row" id="dobFancy"></span>

  <label>DATE OF JOINING:</label>
  <input type="date" id="doj">

  <label>JOINING (Formatted):</label>
  <span class="full-row" id="dojFancy"></span>

  <label>STAFF CATEGORY:</label>
  <select id="category">
    <option value="">Select</option>
    <option>TEACHER</option>
    <option>CLERK</option>
    <option>CLASS-IV</option>
    <option>OTHER</option>
  </select>

  <label>QUALIFICATION:</label>
  <input type="text" id="qualification">

  <label>EXPERIENCE (Years):</label>
  <input type="number" id="experience">

  <label>SALARY (Monthly):</label>
  <input type="number" id="salary">

  <label>FATHER NAME:</label>
  <input type="text" id="father">

  <label>MOTHER NAME:</label>
  <input type="text" id="mother">

  <label>CONTACT:</label>
  <input type="tel" id="contact">

  <label>EMAIL:</label>
  <input type="email" id="email" value="@gmail.com">

  <label class="full-row">ADDRESS:</label>
  <textarea class="full-row" id="address"></textarea>

</form>

<div class="toolbar">

  <button class="btn btn-add" id="addBtn">SAVE</button>
  <button class="btn btn-edit" id="editBtn">EDIT</button>
  <button class="btn btn-delete" id="deleteBtn">DELETE</button>
  <button class="btn btn-home" id="homeBtn">HOME</button>
  <button class="btn btn-csv" id="csvBtn">CSV</button>
  <button class="btn btn-print" id="printBtn">PRINT</button>

  <button class="btn btn-prev" id="prevBtn">PREV</button>
  <button class="btn btn-next" id="nextBtn">NEXT</button>

  <div class="search-box">
    <input type="text" id="searchId" placeholder="Search ID">
    <button class="btn btn-search" id="searchBtn">SEARCH</button>
  </div>

  <!-- Test Button for debugging -->
  <button class="btn btn-test" id="testBtn">TEST: Add Sample</button>

</div>

</div>

<!-- ---------------- STAFF LIST SECTION ---------------- -->
<div class="card" style="margin-top:20px;">
  <h3 style="color:#004d40;margin-top:0;">Staff List</h3>
  <table style="width:100%;border-collapse:collapse;">
    <thead>
      <tr style="background:#e0f2f1;">
        <th style="border:1px solid #b2dfdb;padding:6px;">ID</th>
        <th style="border:1px solid #b2dfdb;padding:6px;">Name</th>
        <th style="border:1px solid #b2dfdb;padding:6px;">Category</th>
        <th style="border:1px solid #b2dfdb;padding:6px;">Contact</th>
      </tr>
    </thead>
    <tbody id="staffListTable"></tbody>
  </table>
</div>

<script>
// ---------- Fancy Date ----------
function ordinal(n){ 
  let s=["th","st","nd","rd"]; 
  let v = n % 100; 
  return n + (s[(v-20)%10] || s[v] || s[0]); 
}

function fancy(d){
  if(!d || d === "") return "";
  const [y,m,day] = d.split("-");
  const dt = new Date(y, m-1, day);
  const mnames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return `${ordinal(dt.getDate())} ${mnames[dt.getMonth()]}, ${dt.getFullYear()}`;
}

// ---------- Status ----------
function status(t){ 
  document.getElementById("statusText").textContent = t; 
  console.log("Status:", t);
}

// ---------- IndexedDB ----------
const DB = "staffDB_v1";
const VER = 1;
let idb = null;

function openDb(){
  return new Promise((resolve, reject) => {
    if(idb) {
      console.log("DB already open");
      return resolve(idb);
    }
    
    console.log("Opening DB...");
    const req = indexedDB.open(DB, VER);
    
    req.onupgradeneeded = function(e) {
      console.log("Upgrading DB...");
      const db = e.target.result;
      if(!db.objectStoreNames.contains("staff")) {
        const store = db.createObjectStore("staff", {keyPath: "staffId"});
        console.log("Object store created");
      }
    };
    
    req.onsuccess = function() {
      console.log("DB opened successfully");
      idb = req.result;
      resolve(idb);
    };
    
    req.onerror = function(e) {
      console.error("DB error:", e.target.error);
      reject(e.target.error);
    };
  });
}

async function saveStaff(staff){
  console.log("Saving staff:", staff.staffId);
  const db = await openDb();
  return new Promise((resolve, reject) => {
    const tx = db.transaction("staff", "readwrite");
    const store = tx.objectStore("staff");
    store.put(staff);
    
    tx.oncomplete = async function() {
      console.log("Staff saved:", staff.staffId);
      const all = await allStaff();
      localStorage.setItem("staff", JSON.stringify(all));
      await loadStaffList();
      resolve();
    };
    
    tx.onerror = function(e) {
      console.error("Save error:", e.target.error);
      reject(e.target.error);
    };
  });
}

async function getStaff(id){
  const db = await openDb();
  return new Promise((resolve, reject) => {
    const tx = db.transaction("staff", "readonly");
    const store = tx.objectStore("staff");
    const req = store.get(id);
    
    req.onsuccess = function() {
      resolve(req.result || null);
    };
    
    req.onerror = function(e) {
      console.error("Get staff error:", e.target.error);
      reject(e.target.error);
    };
  });
}

async function deleteStaff(id){
  const db = await openDb();
  return new Promise((resolve, reject) => {
    const tx = db.transaction("staff", "readwrite");
    const store = tx.objectStore("staff");
    store.delete(id);
    
    tx.oncomplete = async function() {
      console.log("Staff deleted:", id);
      const all = await allStaff();
      localStorage.setItem("staff", JSON.stringify(all));
      await loadStaffList();
      resolve();
    };
    
    tx.onerror = function(e) {
      console.error("Delete error:", e.target.error);
      reject(e.target.error);
    };
  });
}

async function allStaff(){
  try {
    const db = await openDb();
    return new Promise((resolve, reject) => {
      const tx = db.transaction("staff", "readonly");
      const store = tx.objectStore("staff");
      const req = store.getAll();
      
      req.onsuccess = function() {
        resolve(req.result || []);
      };
      
      req.onerror = function(e) {
        console.error("Get all staff error:", e.target.error);
        reject(e.target.error);
      };
    });
  } catch(error) {
    console.error("Error in allStaff:", error);
    return [];
  }
}

async function sortedIds(){
  const all = await allStaff();
  let ids = all.map(s => s.staffId).filter(id => id);
  ids.sort();
  return ids;
}

// FIXED: nextId function
async function nextId(){
  try {
    const all = await allStaff();
    console.log("Total records:", all.length);
    
    if(all.length === 0) {
      console.log("No records, returning SF0001");
      return "SF0001";
    }
    
    // Extract all staff IDs that start with SF
    const ids = all.map(s => s.staffId).filter(id => id && id.startsWith('SF'));
    console.log("All SF IDs:", ids);
    
    if(ids.length === 0) {
      console.log("No SF IDs found, returning SF0001");
      return "SF0001";
    }
    
    // Find the highest number
    let maxNum = 0;
    for(let id of ids) {
      if(id && id.startsWith('SF')) {
        const numStr = id.substring(2);
        const num = parseInt(numStr);
        if(!isNaN(num) && num > maxNum) {
          maxNum = num;
        }
      }
    }
    
    console.log("Max number found:", maxNum);
    const nextNum = maxNum + 1;
    const nextId = "SF" + nextNum.toString().padStart(4, "0");
    console.log("Next ID will be:", nextId);
    
    return nextId;
    
  } catch(error) {
    console.error("Error in nextId:", error);
    return "SF0001";
  }
}

// ---------- Picture ----------
let pic = "";
document.getElementById("staffPicture").addEventListener("change", function(){
  const file = this.files[0];
  if(!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    pic = e.target.result;
    document.getElementById("preview").src = pic;
    console.log("Picture loaded");
  };
  reader.readAsDataURL(file);
});

// ---------- Form ----------
function getForm(){
  return {
    staffId: document.getElementById("staffId").value,
    staffName: document.getElementById("staffName").value,
    dob: document.getElementById("dob").value,
    doj: document.getElementById("doj").value,
    category: document.getElementById("category").value,
    qualification: document.getElementById("qualification").value,
    experience: parseInt(document.getElementById("experience").value) || 0,
    salary: parseInt(document.getElementById("salary").value) || 0,
    father: document.getElementById("father").value,
    mother: document.getElementById("mother").value,
    contact: document.getElementById("contact").value,
    email: document.getElementById("email").value,
    address: document.getElementById("address").value,
    picture: pic
  };
}

function fillForm(staff){
  document.getElementById("staffId").value = staff.staffId || "";
  document.getElementById("staffName").value = staff.staffName || "";
  document.getElementById("dob").value = staff.dob || "";
  document.getElementById("dobFancy").textContent = fancy(staff.dob || "");
  document.getElementById("doj").value = staff.doj || "";
  document.getElementById("dojFancy").textContent = fancy(staff.doj || "");
  document.getElementById("category").value = staff.category || "";
  document.getElementById("qualification").value = staff.qualification || "";
  document.getElementById("experience").value = staff.experience || "";
  document.getElementById("salary").value = staff.salary || "";
  document.getElementById("father").value = staff.father || "";
  document.getElementById("mother").value = staff.mother || "";
  document.getElementById("contact").value = staff.contact || "";
  document.getElementById("email").value = staff.email || "";
  document.getElementById("address").value = staff.address || "";
  pic = staff.picture || "";
  document.getElementById("preview").src = pic;
}

async function clearForm(){
  console.log("Clearing form...");
  document.getElementById("staffForm").reset();
  pic = "";
  document.getElementById("preview").src = "";

  // Set next ID
  const newId = await nextId();
  document.getElementById("staffId").value = newId;
  console.log("New ID set to:", newId);

  // Set current date as DOJ
  const today = new Date();
  const year = today.getFullYear();
  const month = ("0" + (today.getMonth() + 1)).slice(-2);
  const day = ("0" + today.getDate()).slice(-2);
  const todayStr = `${year}-${month}-${day}`;
  
  document.getElementById("doj").value = todayStr;
  document.getElementById("dojFancy").textContent = fancy(todayStr);
}

// ---------- Load Index ----------
let currentIndex = -1;

async function loadIndex(index){
  const ids = await sortedIds();
  console.log("All IDs:", ids, "Requested index:", index);
  
  if(ids.length === 0) {
    status("No data available");
    return;
  }
  
  if(index < 0) index = 0;
  if(index >= ids.length) index = ids.length - 1;
  
  currentIndex = index;
  const staff = await getStaff(ids[index]);
  if(staff) {
    fillForm(staff);
    status(`Record ${index + 1} of ${ids.length}`);
  }
}

// ---------- STAFF LIST LOADING ----------
async function loadStaffList(){
  try {
    const list = await allStaff();
    const table = document.getElementById("staffListTable");
    table.innerHTML = "";
    
    if(list.length === 0) {
      table.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:20px;color:#666;">No staff records found</td></tr>`;
      return;
    }
    
    list.forEach(staff => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td style='border:1px solid #b2dfdb;padding:6px;'>${staff.staffId || ''}</td>
        <td style='border:1px solid #b2dfdb;padding:6px;'>${staff.staffName || ''}</td>
        <td style='border:1px solid #b2dfdb;padding:6px;'>${staff.category || ''}</td>
        <td style='border:1px solid #b2dfdb;padding:6px;'>${staff.contact || ''}</td>
      `;
      table.appendChild(row);
    });
    
    console.log("Staff list loaded:", list.length, "records");
  } catch(error) {
    console.error("Error loading staff list:", error);
  }
}

// ---------- INIT ----------
async function initialize(){
  try {
    console.log("Initializing application...");
    status("Initializing...");
    
    await openDb();
    
    // Set initial ID
    const initialId = await nextId();
    document.getElementById("staffId").value = initialId;
    console.log("Initial ID set to:", initialId);
    
    // Set current date
    const today = new Date();
    const year = today.getFullYear();
    const month = ("0" + (today.getMonth() + 1)).slice(-2);
    const day = ("0" + today.getDate()).slice(-2);
    const todayStr = `${year}-${month}-${day}`;
    
    document.getElementById("doj").value = todayStr;
    document.getElementById("dojFancy").textContent = fancy(todayStr);
    
    // Load existing data
    const ids = await sortedIds();
    console.log("Found", ids.length, "existing records");
    
    if(ids.length > 0) {
      await loadIndex(0);
    }
    
    // Load staff list
    await loadStaffList();
    
    status("Ready");
    console.log("Application initialized successfully");
    
  } catch(error) {
    console.error("Initialization error:", error);
    status("Error initializing");
  }
}

// ---------- Event Listeners ----------
document.addEventListener("DOMContentLoaded", function() {
  initialize();
});

// SAVE button
document.getElementById("addBtn").onclick = async function() {
  const staff = getForm();
  if(!staff.staffName || staff.staffName.trim() === "") {
    alert("Please enter Staff Name!");
    document.getElementById("staffName").focus();
    return;
  }
  
  if(!staff.staffId || staff.staffId.trim() === "") {
    alert("Staff ID is missing!");
    return;
  }
  
  try {
    status("Saving...");
    await saveStaff(staff);
    alert("Staff saved successfully: " + staff.staffId);
    await clearForm();
    status("Ready");
  } catch(error) {
    console.error("Save error:", error);
    alert("Error saving staff!");
    status("Error");
  }
};

// EDIT button
document.getElementById("editBtn").onclick = async function() {
  const id = prompt("Enter Staff ID to edit:");
  if(!id) return;
  
  try {
    const staff = await getStaff(id);
    if(!staff) {
      alert("Staff not found: " + id);
      return;
    }
    
    fillForm(staff);
    const ids = await sortedIds();
    currentIndex = ids.indexOf(id);
    if(currentIndex >= 0) {
      status(`Editing record ${currentIndex + 1} of ${ids.length}`);
    }
  } catch(error) {
    console.error("Edit error:", error);
    alert("Error loading staff!");
  }
};

// DELETE button
document.getElementById("deleteBtn").onclick = async function() {
  const id = document.getElementById("staffId").value;
  if(!id || id.trim() === "") {
    alert("No staff selected!");
    return;
  }
  
  if(!confirm(`Are you sure you want to delete staff ${id}?`)) {
    return;
  }
  
  try {
    status("Deleting...");
    await deleteStaff(id);
    alert("Staff deleted: " + id);
    
    const ids = await sortedIds();
    if(ids.length > 0) {
      await loadIndex(0);
    } else {
      await clearForm();
    }
    status("Ready");
  } catch(error) {
    console.error("Delete error:", error);
    alert("Error deleting staff!");
    status("Error");
  }
};

// NEXT button
document.getElementById("nextBtn").onclick = async function() {
  const ids = await sortedIds();
  if(ids.length === 0) {
    alert("No records available");
    return;
  }
  
  if(currentIndex < ids.length - 1) {
    currentIndex++;
    await loadIndex(currentIndex);
  } else {
    alert("This is the last record");
  }
};

// PREV button
document.getElementById("prevBtn").onclick = async function() {
  const ids = await sortedIds();
  if(ids.length === 0) {
    alert("No records available");
    return;
  }
  
  if(currentIndex > 0) {
    currentIndex--;
    await loadIndex(currentIndex);
  } else {
    alert("This is the first record");
  }
};

// SEARCH button
document.getElementById("searchBtn").onclick = async function() {
  const id = document.getElementById("searchId").value.trim();
  if(!id) {
    alert("Please enter Staff ID to search");
    return;
  }
  
  try {
    const staff = await getStaff(id);
    if(!staff) {
      alert("Staff not found: " + id);
      return;
    }
    
    fillForm(staff);
    const ids = await sortedIds();
    currentIndex = ids.indexOf(id);
    if(currentIndex >= 0) {
      status(`Record ${currentIndex + 1} of ${ids.length}`);
    }
  } catch(error) {
    console.error("Search error:", error);
    alert("Error searching staff!");
  }
};

// TEST button (for debugging)
document.getElementById("testBtn").onclick = async function() {
  try {
    const testId = await nextId();
    const testStaff = {
      staffId: testId,
      staffName: "Test Staff " + testId,
      dob: "1990-01-15",
      doj: new Date().toISOString().split('T')[0],
      category: "TEACHER",
      qualification: "M.A, B.Ed",
      experience: 5,
      salary: 30000,
      father: "Test Father",
      mother: "Test Mother",
      contact: "9876543210",
      email: "test" + testId + "@gmail.com",
      address: "Test Address, Kolkata",
      picture: ""
    };
    
    await saveStaff(testStaff);
    alert("Test staff added: " + testId);
    await clearForm();
    await loadStaffList();
  } catch(error) {
    console.error("Test error:", error);
    alert("Error adding test data!");
  }
};

// PRINT button
document.getElementById("printBtn").onclick = function() {
  window.print();
};

// HOME button
document.getElementById("homeBtn").onclick = function() {
  if(confirm("Go to home page?")) {
    window.location.href = "index.html";
  }
};

// CSV EXPORT
document.getElementById("csvBtn").onclick = function() {
  const staff = getForm();
  const headers = ["ID","NAME","DOB","DOJ","CATEGORY","QUALIFICATION","EXPERIENCE","SALARY","FATHER","MOTHER","CONTACT","EMAIL","ADDRESS"];
  const values = [
    staff.staffId,
    staff.staffName,
    staff.dob,
    staff.doj,
    staff.category,
    staff.qualification,
    staff.experience,
    staff.salary,
    staff.father,
    staff.mother,
    staff.contact,
    staff.email,
    staff.address
  ];
  
  const csvContent = headers.join(",") + "\n" + values.map(v => `"${v || ""}"`).join(",");
  const blob = new Blob([csvContent], {type: "text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = staff.staffId + "_staff.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
};

// Add event listener for date fields to update fancy dates
document.getElementById("dob").addEventListener("change", function() {
  document.getElementById("dobFancy").textContent = fancy(this.value);
});

document.getElementById("doj").addEventListener("change", function() {
  document.getElementById("dojFancy").textContent = fancy(this.value);
});

// Make search work with Enter key
document.getElementById("searchId").addEventListener("keypress", function(e) {
  if(e.key === "Enter") {
    document.getElementById("searchBtn").click();
  }
});
</script>

</body>
</html>