
/* ========= NUMBER â†’ WORDS (Indian Format) ========== */
function numberToIndianWords(n){
    n = Math.round(Number(n)||0);
    if(n===0) return "zero rupees";

    let ones=["","one","two","three","four","five","six","seven","eight","nine","ten",
        "eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen",
        "eighteen","nineteen"];
    let tens=["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];

    function twoDigits(num){
        if(num===0) return "";
        if(num<20) return ones[num];
        return tens[Math.floor(num/10)] + (num%10? " "+ones[num%10]:"");
    }
    function threeDigits(num){
        let h=Math.floor(num/100);
        let rest=num%100;
        let out=[];
        if(h>0) out.push(ones[h]+" hundred");
        if(rest>0){
            if(out.length) out.push("and");
            out.push(twoDigits(rest));
        }
        return out.join(" ");
    }

    let out=[];
    let crore=Math.floor(n/10000000); n%=10000000;
    let lakh=Math.floor(n/100000); n%=100000;
    let thousand=Math.floor(n/1000); n%=1000;
    let hundred=n;

    if(crore) out.push(threeDigits(crore)+" crore");
    if(lakh)  out.push(threeDigits(lakh)+" lakh");
    if(thousand) out.push(threeDigits(thousand)+" thousand");
    if(hundred) out.push(threeDigits(hundred));

    return out.join(" ")+" rupees";
}

/* ========= STATUS ========= */
function setStatus(msg){
    document.getElementById("statusText").textContent = msg;
}

/* ========= DATE FORMAT ========= */
function ordinal(n){
    let s=["th","st","nd","rd"], v=n%100;
    return n+(s[(v-20)%10]||s[v]||s[0]);
}
function formatFancy(iso){
    if(!iso) return "";
    let [y,m,d] = iso.split("-");
    let dt=new Date(y,m-1,d);
    let months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return ordinal(dt.getDate())+" "+months[dt.getMonth()]+", "+dt.getFullYear();
}

/* ========= FEE DB ========= */
const FEE_DB="feeDB_git_safe_v1";
let feeDb=null;

function openFeeDb(){
    return new Promise(resolve=>{
        if(feeDb) return resolve(feeDb);
        let req=indexedDB.open(FEE_DB,1);
        req.onupgradeneeded=e=>{
            let db=e.target.result;
            if(!db.objectStoreNames.contains("fees")){
                db.createObjectStore("fees",{keyPath:"billNo"});
            }
        };
        req.onsuccess=e=>{
            feeDb=e.target.result;
            resolve(feeDb);
        };
    });
}

async function saveFee(rec){
    let db=await openFeeDb();
    return new Promise(res=>{
        let tx=db.transaction("fees","readwrite");
        tx.objectStore("fees").put(rec);
        tx.oncomplete=res;
    });
}
async function getAllFees(){
    let db=await openFeeDb();
    return new Promise(res=>{
        let tx=db.transaction("fees","readonly");
        let req=tx.objectStore("fees").getAll();
        req.onsuccess=()=>res(req.result||[]);
    });
}
async function getFee(id){
    let db=await openFeeDb();
    return new Promise(res=>{
        let tx=db.transaction("fees","readonly");
        let req=tx.objectStore("fees").get(id);
        req.onsuccess=()=>res(req.result||null);
    });
}
async function deleteFee(id){
    let db=await openFeeDb();
    return new Promise(res=>{
        let tx=db.transaction("fees","readwrite");
        tx.objectStore("fees").delete(id);
        tx.oncomplete=res;
    });
}

/* ========= STUDENT DB AUTO-FILL (MERGED) ========= */
const STUDENT_DB="schoolDB_v1";
async function getStudentById(studentId){
    return new Promise(resolve=>{
        let req=indexedDB.open(STUDENT_DB);
        req.onsuccess=e=>{
            let db=e.target.result;
            let tx=db.transaction("students","readonly");
            let store=tx.objectStore("students");
            let r=store.get(studentId);
            r.onsuccess=()=>resolve(r.result||null);
        };
        req.onerror=()=>resolve(null);
    });
}

/* AUTO LOAD STUDENT */
studentId.addEventListener("blur",async()=>{
    let id=studentId.value.trim();
    if(!id) return;
    let s=await getStudentById(id);
    if(!s){ setStatus("Student not found"); return; }

    studentName.value=s.studentName||"";
    className.value=s.className||"";
    section.value=s.section||"";
    roll.value=s.roll||"";
    setStatus("Student loaded: "+s.studentName);
});
