<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Detail (PWA – Final Version)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#283593">
  <link rel="manifest" href="manifest.json">

  <style>
    body{
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin:0 auto;
      padding:20px;
      background:linear-gradient(135deg,#e0f7fa,#e8eaf6);
    }
    h1{ text-align:center; color:#283593; }
    .status-bar{
      font-size:12px; background:#e3f2fd; padding:6px 12px;
      border-radius:6px; margin-bottom:10px; color:#1a237e;
    }
    .card{
      background:#fff; border-radius:8px; padding:20px;
      box-shadow:0 2px 8px rgba(0,0,0,0.2); position:relative;
    }
    form{
      display:grid; grid-template-columns:1fr 2fr; gap:10px 15px;
    }
    label{ font-weight:bold; color:#1a237e;}
    input,select,textarea{
      width:100%; padding:6px 8px; box-sizing:border-box;
      border:1px solid #c5cae9; border-radius:4px; font-size:13px;
    }
    textarea{resize:vertical;}
    #preview{
      max-width:100px; max-height:120px; object-fit:cover;
      position:absolute; top:20px; right:20px;
      border-radius:4px; border:1px solid #c5cae9;
    }
    .full-row{ grid-column:1/3; }
    .toolbar{
      margin-top:20px; display:flex; flex-wrap:wrap;
      gap:10px; align-items:center; justify-content:space-between;
    }
    .btn{
      border:none; border-radius:4px; padding:8px 14px;
      color:#fff; cursor:pointer; font-weight:600;
      font-size:13px; box-shadow:0 2px 4px rgba(0,0,0,0.2);
    }
    .btn-add{background:#2e7d32;} .btn-edit{background:#0288d1;}
    .btn-delete{background:#c62828;} .btn-home{background:#6a1b9a;}
    .btn-csv{background:#00897b;} .btn-print{background:#ef6c00;}
    .btn-prev{background:#5d4037;} .btn-next{background:#00796b;}
    .btn-search{background:#3949ab;}
    .btn-json-export{background:#004d40;}
    .btn-json-import{background:#ad1457;}

    .search-box{display:flex; gap:6px; align-items:center;}
    .search-box input{width:120px;}

    @media(max-width:600px){
      form{ grid-template-columns:1fr; }
      .full-row{ grid-column:1/2; }
      #preview{ position:static; margin-bottom:10px; }
      .toolbar{flex-direction:column; align-items:flex-start;}
      .search-box{width:100%;} .search-box input{flex:1;}
    }
    @media print{ .toolbar,.status-bar{display:none;} }
  </style>
</head>
<body>

<h1>Student Detail (FINAL)</h1>

<div class="status-bar">Status: <span id="statusText">Loading...</span></div>

<div class="card">

  <img id="preview">

  <form id="studentForm">

    <label>STUDENT NAME:</label>
    <input type="text" id="studentName">

    <label>STUDENT PICTURE:</label>
    <input type="file" id="studentPicture" accept="image/*">

    <label>STUDENT ID (AUTO):</label>
    <input type="text" id="studentId" readonly>

    <label>DOB:</label>
    <input type="date" id="dob">

    <label>DOB (Formatted):</label>
    <span class="full-row" id="dobFancy"></span>

    <label>ADMISSION DATE:</label>
    <input type="date" id="doa">

    <label>ADMISSION (Formatted):</label>
    <span class="full-row" id="doaFancy"></span>

    <label>CLASS:</label>
    <select id="className">
      <option value="">Select</option>
      <option>PLAY GROUP</option>
      <option>NURSURY</option>
      <option>JUNIOUR K.G.</option>
      <option>SENIOUR K.G.</option>
      <option>CLASS – I</option>
      <option>CLASS – II</option>
      <option>CLASS – III</option>
      <option>CLASS – IV</option>
      <option>CLASS – V</option>
    </select>

    <label>SECTION:</label>
    <input type="text" id="section" placeholder="A / B / C">

    <label>ROLL NO:</label>
    <input type="number" id="roll">

    <label>CATEGORY:</label>
    <select id="category">
      <option value="">Select</option>
      <option>NEW ADMISSION</option>
      <option>PROMOTE</option>
      <option>OTHER</option>
    </select>

    <label>FATHER NAME:</label>
    <input type="text" id="fatherName">

    <label>MOTHER NAME:</label>
    <input type="text" id="motherName">

    <label>MOBILE:</label>
    <input type="tel" id="contact">

    <label>EMAIL:</label>
    <input type="email" id="email" value="@gmail.com">

    <label class="full-row">ADDRESS:</label>
    <textarea class="full-row" id="address"></textarea>

  </form>

  <div class="toolbar">

    <button class="btn btn-add" id="addBtn">ADD / SAVE</button>
    <button class="btn btn-edit" id="editBtn">EDIT</button>
    <button class="btn btn-delete" id="deleteBtn">DELETE</button>
    <button class="btn btn-home" id="homeBtn">HOME</button>
    <button class="btn btn-csv" id="csvBtn">CSV</button>
    <button class="btn btn-print" id="printBtn">PRINT</button>

    <button class="btn btn-prev" id="prevBtn">PREV</button>
    <button class="btn btn-next" id="nextBtn">NEXT</button>

    <div class="search-box">
      <input type="text" id="searchId" placeholder="Search ID">
      <button class="btn btn-search" id="searchBtn">SEARCH</button>
    </div>

    <button class="btn btn-json-export" id="jsonExportBtn">EXPORT JSON</button>
    <button class="btn btn-json-import" id="jsonImportBtn">IMPORT JSON</button>
    <input type="file" id="jsonFileInput" accept="application/json" style="display:none">

  </div>
</div>
<!-- ================== SAVED STUDENT LIST ================== -->
<br><br>
<div class="card">
  <h2 style="color:#1a237e; margin-top:0;">Saved Student Records</h2>

  <table id="studentTable" 
         style="width:100%; border-collapse:collapse; font-size:13px;">
    <thead>
      <tr style="background:#e8eaf6; color:#1a237e;">
        <th style="border:1px solid #c5cae9; padding:6px;">ID</th>
        <th style="border:1px solid #c5cae9; padding:6px;">Name</th>
        <th style="border:1px solid #c5cae9; padding:6px;">Class</th>
        <th style="border:1px solid #c5cae9; padding:6px;">Roll</th>
        <th style="border:1px solid #c5cae9; padding:6px;">Father</th>
        <th style="border:1px solid #c5cae9; padding:6px;">Contact</th>
      </tr>
    </thead>
    <tbody id="studentTableBody"></tbody>
  </table>
</div>


<script>
// ========== Fancy Date Helpers ==========
function ordinal(n){
  let s=["th","st","nd","rd"], v=n%100;
  return n+(s[(v-20)%10]||s[v]||s[0]);
}
function formatFancy(d){
  if(!d) return "";
  const [y,m,day] = d.split("-");
  const dt=new Date(y,m-1,day);
  const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return `${ordinal(dt.getDate())} ${months[dt.getMonth()]}, ${dt.getFullYear()}`;
}

// ========== Status ==========
function setStatus(t){ document.getElementById("statusText").textContent=t; }

// ========== IndexedDB ==========
const DB="schoolDB_v1";
const VER=1;
let idb=null;

function openDb(){
  return new Promise((resolve)=>{
    if(idb) return resolve(idb);
    const req=indexedDB.open(DB,VER);
    req.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains("students")){
        db.createObjectStore("students",{keyPath:"studentId"});
      }
    };
    req.onsuccess=()=>{idb=req.result; resolve(idb);};
  });
}

async function saveStudent(s){
  const db=await openDb();
  return new Promise(res=>{
    const tx=db.transaction("students","readwrite");
    tx.objectStore("students").put(s);
    tx.oncomplete=res;
  });
}
async function getStudent(id){
  const db=await openDb();
  return new Promise(res=>{
    const tx=db.transaction("students","readonly");
    const req=tx.objectStore("students").get(id);
    req.onsuccess=()=>res(req.result||null);
  });
}
async function deleteStudent(id){
  const db=await openDb();
  return new Promise(res=>{
    const tx=db.transaction("students","readwrite");
    tx.objectStore("students").delete(id);
    tx.oncomplete=res;
  });
}
async function getAllStudents(){
  const db=await openDb();
  return new Promise(res=>{
    const tx=db.transaction("students","readonly");
    const req=tx.objectStore("students").getAll();
    req.onsuccess=()=>res(req.result||[]);
  });
}
async function getSortedIds(){
  const all=await getAllStudents();
  const ids=all.map(s=>s.studentId);
  ids.sort();
  return ids;
}
async function generateNextId(){
  const ids=await getSortedIds();
  if(ids.length===0) return "ST0001";
  const last=ids[ids.length-1];
  const n=parseInt(last.substring(2))+1;
  return "ST"+n.toString().padStart(4,"0");
}

// ========== Picture Preview ==========
let pictureData="";
document.getElementById("studentPicture").addEventListener("change",function(){
  const f=this.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=e=>{
    pictureData=e.target.result;
    document.getElementById("preview").src=pictureData;
  };
  r.readAsDataURL(f);
});

// ========== Form Helpers ==========
function getForm(){
  return {
    studentId: document.getElementById("studentId").value,
    studentName: document.getElementById("studentName").value,
    dob: document.getElementById("dob").value,
    doa: document.getElementById("doa").value,
    className: document.getElementById("className").value,
    section: document.getElementById("section").value,
    roll: document.getElementById("roll").value,
    category: document.getElementById("category").value,
    fatherName: document.getElementById("fatherName").value,
    motherName: document.getElementById("motherName").value,
    contact: document.getElementById("contact").value,
    email: document.getElementById("email").value,
    address: document.getElementById("address").value,
    picture: pictureData
  };
}
function fillForm(d){
  document.getElementById("studentId").value=d.studentId;
  document.getElementById("studentName").value=d.studentName;
  document.getElementById("dob").value=d.dob;
  document.getElementById("dobFancy").textContent=formatFancy(d.dob);
  document.getElementById("doa").value=d.doa;
  document.getElementById("doaFancy").textContent=formatFancy(d.doa);
  document.getElementById("className").value=d.className;
  document.getElementById("section").value=d.section;
  document.getElementById("roll").value=d.roll;
  document.getElementById("category").value=d.category;
  document.getElementById("fatherName").value=d.fatherName;
  document.getElementById("motherName").value=d.motherName;
  document.getElementById("contact").value=d.contact;
  document.getElementById("email").value=d.email;
  document.getElementById("address").value=d.address;
  pictureData = d.picture;
  document.getElementById("preview").src = pictureData;
}
async function clearForm(){
  document.getElementById("studentForm").reset();
  pictureData="";
  document.getElementById("preview").src="";
  const id=await generateNextId();
  document.getElementById("studentId").value=id;

  // Set default Admission Date = today
  const t=new Date();
  const y=t.getFullYear();
  const m=("0"+(t.getMonth()+1)).slice(-2);
  const d=("0"+t.getDate()).slice(-2);
  document.getElementById("doa").value=`${y}-${m}-${d}`;
  document.getElementById("doaFancy").textContent=formatFancy(`${y}-${m}-${d}`);
}

// ========== Load First ==========
let currentIndex=-1;

async function loadIndex(i){
  const ids=await getSortedIds();
  if(!ids.length){setStatus("No records"); return;}
  if(i<0) i=0;
  if(i>=ids.length) i=ids.length-1;
  currentIndex=i;
  const rec=await getStudent(ids[i]);
  if(rec) fillForm(rec);
}

// ========== INIT ==========
(async ()=>{
  setStatus("Opening database...");
  await openDb();

  document.getElementById("studentId").value = await generateNextId();

  // Default Admission Date = Today
  const t=new Date();
  const y=t.getFullYear(), m=("0"+(t.getMonth()+1)).slice(-2), d=("0"+t.getDate()).slice(-2);
  document.getElementById("doa").value=`${y}-${m}-${d}`;
  document.getElementById("doaFancy").textContent=formatFancy(`${y}-${m}-${d}`);

  const ids=await getSortedIds();
  if(ids.length>0) loadIndex(0);

  setStatus("Ready");
})();

// ========== Buttons ==========

document.getElementById("addBtn").onclick = async ()=>{
  const d=getForm();
  if(!d.studentName){alert("Name empty"); return;}
  await saveStudent(d);
  alert("Saved: "+d.studentId);
  await clearForm();
};

document.getElementById("editBtn").onclick = async ()=>{
  const id=prompt("Enter ID:");
  if(!id) return;
  const r=await getStudent(id);
  if(!r){alert("Not found"); return;}
  fillForm(r);
  const ids=await getSortedIds();
  currentIndex=ids.indexOf(id);
};

document.getElementById("deleteBtn").onclick = async ()=>{
  const id=document.getElementById("studentId").value;
  if(!confirm("Delete "+id+"?")) return;
  await deleteStudent(id);
  alert("Deleted");
  const ids=await getSortedIds();
  if(ids.length>0) loadIndex(0); else clearForm();
};

document.getElementById("searchBtn").onclick = async ()=>{
  const id=document.getElementById("searchId").value;
  const r=await getStudent(id);
  if(!r){alert("Not found"); return;}
  fillForm(r);
};

document.getElementById("nextBtn").onclick = async ()=>{
  const ids=await getSortedIds();
  if(currentIndex<ids.length-1){
    currentIndex++; loadIndex(currentIndex);
  }
};
document.getElementById("prevBtn").onclick = async ()=>{
  if(currentIndex>0){
    currentIndex--; loadIndex(currentIndex);
  }
};

document.getElementById("printBtn").onclick=()=>window.print();
document.getElementById("homeBtn").onclick=()=>location.href="index.html";

document.getElementById("csvBtn").onclick = ()=>{
  const d=getForm();
  const headers=["ID","NAME","DOB","DOA","CLASS","SECTION","ROLL","CATEGORY","FATHER","MOTHER","CONTACT","EMAIL","ADDRESS"];
  const vals=[d.studentId,d.studentName,d.dob,d.doa,d.className,d.section,d.roll,d.category,d.fatherName,d.motherName,d.contact,d.email,d.address];
  const csv=headers.join(",")+"\n"+vals.map(v=>`"${v||""}"`).join(",");
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=d.studentId+"_student.csv"; a.click();
  URL.revokeObjectURL(url);
};

// JSON Backup
document.getElementById("jsonExportBtn").onclick=async()=>{
  const all=await getAllStudents();
  const blob=new Blob([JSON.stringify(all,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="students_backup.json"; a.click();
};

// JSON Import
document.getElementById("jsonImportBtn").onclick=()=>{
  document.getElementById("jsonFileInput").click();
};
document.getElementById("jsonFileInput").addEventListener("change",function(){
  const f=this.files[0];
  const r=new FileReader();
  r.onload=async e=>{
    const arr=JSON.parse(e.target.result);
    for(const s of arr) await saveStudent(s);
    alert("Import Done");
    loadIndex(0);
  };
  r.readAsText(f);
});

async function loadStudentTable(){
  const all = await getAllStudents();
  const tbody = document.getElementById("studentTableBody");
  tbody.innerHTML = "";

  all.sort((a,b) => a.studentId.localeCompare(b.studentId));

  all.forEach(st => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="border:1px solid #c5cae9; padding:5px;">${st.studentId}</td>
      <td style="border:1px solid #c5cae9; padding:5px;">${st.studentName}</td>
      <td style="border:1px solid #c5cae9; padding:5px;">${st.className}</td>
      <td style="border:1px solid #c5cae9; padding:5px;">${st.roll}</td>
      <td style="border:1px solid #c5cae9; padding:5px;">${st.fatherName}</td>
      <td style="border:1px solid #c5cae9; padding:5px;">${st.contact}</td>
    `;
    tbody.appendChild(tr);
  });
}

// Load table on page start
window.onload = ()=> { 
  setTimeout(loadStudentTable, 800); 
};

// Load table every time new record is saved
document.getElementById("addBtn").addEventListener("click", ()=>{
  setTimeout(loadStudentTable, 800);
});
</script>


</body>
</html>
